<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏£‡∏∞‡∏ö‡∏ö‡∏•‡∏≤‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå (Sanitation Dept.)</title>
    
    <!-- Libraries -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;600;800&display=swap" rel="stylesheet">
    
    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
    
    <!-- PDF Lib -->
    <script src="https://unpkg.com/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>
    <script src="https://unpkg.com/@pdf-lib/fontkit@0.0.4/dist/fontkit.umd.min.js"></script>

    <style>
        body { font-family: 'Sarabun', sans-serif; background: linear-gradient(135deg, #fdfbf7 0%, #eef2f3 100%); }
        .pastel-card { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); border-radius: 20px; box-shadow: 0 10px 30px -5px rgba(0, 0, 0, 0.05); border: 1px solid rgba(255, 255, 255, 0.5); }
        .hidden-section { display: none; }
    </style>
</head>
<body class="text-gray-700">

    <!-- Loading -->
    <div id="loading-screen" class="fixed inset-0 bg-pink-50 z-50 flex flex-col items-center justify-center">
        <div class="animate-bounce text-6xl mb-4">üê∞</div>
        <p class="text-pink-400 text-xl font-bold animate-pulse">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</p>
    </div>

    <!-- Home -->
    <div id="screen-home" class="min-h-screen flex flex-col items-center justify-center px-4 py-10 hidden-section bg-gradient-to-b from-pink-50 to-blue-50">
        <div class="text-center mb-8">
            <div class="text-6xl mb-2">üè•‚ú®</div>
            <h1 class="text-3xl font-extrabold text-gray-700">‡∏£‡∏∞‡∏ö‡∏ö‡πÉ‡∏ö‡∏•‡∏≤‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå</h1>
            <p class="text-gray-500 mt-2">‡πÅ‡∏ú‡∏ô‡∏Å‡∏™‡∏∏‡∏Ç‡∏≤‡∏†‡∏¥‡∏ö‡∏≤‡∏• ‡∏Å‡∏≠‡∏á‡πÄ‡∏ß‡∏ä‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô ‡∏Å‡∏£‡∏°‡πÅ‡∏û‡∏ó‡∏¢‡πå‡∏ó‡∏´‡∏≤‡∏£‡∏≠‡∏≤‡∏Å‡∏≤‡∏®</p>
        </div>
        <div class="w-full max-w-md pastel-card p-6">
            <label class="block text-gray-600 font-bold mb-3 ml-1">üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ ‡∏´‡∏£‡∏∑‡∏≠ ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì</label>
            <input type="text" id="searchInput" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏•‡πà‡∏ô ‡∏´‡∏£‡∏∑‡∏≠ ‡∏ä‡∏∑‡πà‡∏≠‡∏à‡∏£‡∏¥‡∏á..." class="w-full pl-4 p-4 rounded-xl bg-gray-50 border-2 border-pink-100 focus:outline-none focus:ring-2 focus:ring-pink-200 mb-4" onkeyup="filterUsers()">
            <div id="userList" class="h-64 overflow-y-auto space-y-2 pr-2"></div>
        </div>
        
        <!-- DIAGNOSTIC BUTTON -->
        <button onclick="runDiagnostics()" class="mt-10 text-xs text-gray-400 border border-gray-300 px-3 py-1 rounded hover:bg-gray-100">
            üõ†Ô∏è ‡πÄ‡∏ä‡πá‡∏Ñ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÑ‡∏ü‡∏•‡πå (‡∏Å‡∏î‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏°‡∏µ‡∏õ‡∏±‡∏ç‡∏´‡∏≤)
        </button>
        <div id="debug-log" class="mt-2 text-xs text-red-500 whitespace-pre-wrap max-w-md"></div>
    </div>

    <!-- Dashboard -->
    <div id="screen-dashboard" class="hidden-section min-h-screen bg-gray-50 pb-10">
        <div class="bg-white rounded-b-3xl shadow-sm p-6 mb-6 relative overflow-hidden">
            <div class="flex justify-between items-start relative z-10">
                <div class="flex items-center">
                    <div class="h-14 w-14 bg-gradient-to-tr from-pink-300 to-purple-300 rounded-2xl flex items-center justify-center text-white text-2xl font-bold shadow-md mr-4">
                        <span id="user-initial">?</span>
                    </div>
                    <div>
                        <h2 id="user-fullname" class="text-xl font-bold text-gray-800">...</h2>
                        <span class="inline-block bg-blue-100 text-blue-600 text-xs px-2 py-1 rounded-full font-bold mt-1">‡∏Å‡∏≠‡∏á‡πÄ‡∏ß‡∏ä‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô ‡∏û‡∏≠.</span>
                    </div>
                </div>
                <button onclick="goHome()" class="bg-gray-100 hover:bg-gray-200 text-gray-500 p-2 rounded-xl transition">‚ùå ‡∏≠‡∏≠‡∏Å</button>
            </div>
        </div>

        <div class="container mx-auto px-4 max-w-2xl">
            <div class="flex bg-white p-1 rounded-2xl shadow-sm mb-6 mx-4">
                <button onclick="switchTab('request')" id="btn-tab-request" class="flex-1 py-3 text-center rounded-xl font-bold text-sm bg-pink-400 text-white shadow-md">üìù ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡πÉ‡∏ö‡∏•‡∏≤</button>
                <button onclick="switchTab('history')" id="btn-tab-history" class="flex-1 py-3 text-center rounded-xl font-bold text-sm text-gray-500 hover:bg-gray-50">üìä ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡∏±‡∏ô‡∏•‡∏≤</button>
            </div>

            <div id="tab-request" class="mx-2">
                <div class="pastel-card p-6 bg-white">
                    <form id="leaveForm" onsubmit="handleSaveAndPrint(event)">
                        <div class="mb-5">
                            <label class="block text-gray-700 font-bold mb-2">üìå ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£</label>
                            <select id="leaveType" class="w-full p-4 rounded-xl bg-blue-50 font-medium text-blue-800 focus:outline-none" onchange="toggleFields()">
                                <option value="vacation">üèñÔ∏è ‡∏•‡∏≤‡∏û‡∏±‡∏Å‡∏ú‡πà‡∏≠‡∏ô (‡πÅ‡∏ö‡∏ö ‡πó)</option>
                                <option value="sick">üò∑ ‡∏•‡∏≤‡∏õ‡πà‡∏ß‡∏¢ (‡πÅ‡∏ö‡∏ö ‡πì)</option>
                                <option value="personal">üöó ‡∏•‡∏≤‡∏Å‡∏¥‡∏à (‡πÅ‡∏ö‡∏ö ‡πñ)</option>
                                <option value="ordination">üôè ‡∏•‡∏≤‡∏≠‡∏∏‡∏õ‡∏™‡∏°‡∏ö‡∏ó (‡πÅ‡∏ö‡∏ö ‡πò)</option>
                                <option value="maternity">üë∂ ‡∏•‡∏≤‡∏Ñ‡∏•‡∏≠‡∏î‡∏ö‡∏∏‡∏ï‡∏£ (‡πÅ‡∏ö‡∏ö ‡πî)</option>
                                <option value="help_wife">üë®‚Äçüçº ‡∏•‡∏≤‡∏ä‡πà‡∏ß‡∏¢‡∏†‡∏£‡∏¥‡∏¢‡∏≤‡∏Ñ‡∏•‡∏≠‡∏î (‡πÅ‡∏ö‡∏ö ‡πï)</option>
                                <option value="cancel" class="text-red-600 font-bold bg-red-50">‚ùå ‡∏Ç‡∏≠‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏ß‡∏±‡∏ô‡∏•‡∏≤ (‡πÅ‡∏ö‡∏ö ‡πë‡πñ)</option>
                            </select>
                        </div>

                        <div id="cancelSection" class="hidden-section mb-6 bg-red-50 p-4 rounded-xl border border-red-100">
                            <h3 class="text-red-500 font-bold mb-3">üö´ ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ö‡∏•‡∏≤‡πÄ‡∏î‡∏¥‡∏°</h3>
                            <div class="mb-3">
                                <label class="block text-gray-600 text-xs mb-1">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏ß‡∏±‡∏ô‡∏•‡∏≤‡∏ó‡∏µ‡πà‡∏Ñ‡∏∑‡∏ô</label>
                                <select id="cancelTargetType" class="w-full p-3 rounded-lg border border-red-200 text-sm">
                                    <option value="sick">üò∑ ‡∏•‡∏≤‡∏õ‡πà‡∏ß‡∏¢</option>
                                    <option value="vacation">üèñÔ∏è ‡∏•‡∏≤‡∏û‡∏±‡∏Å‡∏ú‡πà‡∏≠‡∏ô</option>
                                    <option value="personal">üöó ‡∏•‡∏≤‡∏Å‡∏¥‡∏à</option>
                                </select>
                            </div>
                            <div class="grid grid-cols-2 gap-3 mb-3">
                                <div><label class="block text-gray-500 text-xs mb-1">‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏•‡∏≤‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</label><input type="date" id="origStart" class="w-full p-2 rounded-lg border border-gray-200 text-sm"></div>
                                <div><label class="block text-gray-500 text-xs mb-1">‡∏ñ‡∏∂‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</label><input type="date" id="origEnd" class="w-full p-2 rounded-lg border border-gray-200 text-sm"></div>
                            </div>
                        </div>

                        <div class="grid grid-cols-2 gap-4 mb-5">
                            <div><label id="labelStartDate" class="block text-gray-600 text-sm mb-1 ml-1">‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</label><input type="date" id="startDate" class="w-full p-3 rounded-xl bg-gray-50 border border-gray-200" required></div>
                            <div><label id="labelEndDate" class="block text-gray-600 text-sm mb-1 ml-1">‡∏ñ‡∏∂‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</label><input type="date" id="endDate" class="w-full p-3 rounded-xl bg-gray-50 border border-gray-200" required></div>
                        </div>

                        <div class="mb-6">
                            <label class="block text-gray-700 font-bold mb-2">üìù ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°</label>
                            <textarea id="reason" rows="3" class="w-full p-4 rounded-xl bg-yellow-50 text-gray-700 placeholder-gray-400 focus:outline-none" placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î..."></textarea>
                        </div>

                        <button type="submit" id="btn-submit" class="w-full bg-gradient-to-r from-pink-400 to-rose-400 text-white text-lg py-4 rounded-2xl font-bold shadow-lg shadow-pink-200 btn-pastel flex justify-center items-center gap-2">
                            <span>üñ®Ô∏è</span> ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡∏∞‡∏û‡∏¥‡∏°‡∏û‡πå‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£
                        </button>
                    </form>
                </div>
            </div>

            <div id="tab-history" class="hidden-section mx-2">
                <div class="grid grid-cols-3 gap-3 mb-6">
                    <div class="bg-red-50 p-4 rounded-2xl text-center border border-red-100"><p class="text-xs text-red-400 font-bold">‡∏õ‡πà‡∏ß‡∏¢‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠</p><p class="text-3xl font-extrabold text-red-500" id="quota-sick">-</p></div>
                    <div class="bg-blue-50 p-4 rounded-2xl text-center border border-blue-100"><p class="text-xs text-blue-400 font-bold">‡∏Å‡∏¥‡∏à‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠</p><p class="text-3xl font-extrabold text-blue-500" id="quota-personal">-</p></div>
                    <div class="bg-green-50 p-4 rounded-2xl text-center border border-green-100"><p class="text-xs text-green-400 font-bold">‡∏û‡∏±‡∏Å‡∏£‡πâ‡∏≠‡∏ô‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠</p><p class="text-3xl font-extrabold text-green-500" id="quota-vacation">-</p></div>
                </div>
                <div class="bg-white rounded-2xl shadow-sm p-5">
                    <h3 class="font-bold text-gray-700 mb-4">üïí ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏•‡∏≤</h3>
                    <ul id="historyList" class="space-y-3"></ul>
                </div>
            </div>
        </div>
    </div>

    <!-- LOGIC -->
    <script>
        // FIREBASE SETUP
        const firebaseConfig = {
            apiKey: "AIzaSyAxgj4sKMUdMQJWj2hU2rbcT4eZ926sskQ",
            authDomain: "leave-system-online.firebaseapp.com",
            projectId: "leave-system-online",
            storageBucket: "leave-system-online.firebasestorage.app",
            messagingSenderId: "801381918860",
            appId: "1:801381918860:web:035197d704d8e6712f73a9",
            measurementId: "G-D4P9EB6K7H"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        // USER DATA
        const initialUsers = [
            { id: "u001", rank: "‡∏ô.‡∏ó.‡∏´‡∏ç‡∏¥‡∏á", name: "‡∏û‡∏±‡∏ä‡∏£‡∏¥‡∏ô‡∏ó‡∏£‡πå ‡∏ß‡∏á‡∏©‡πå‡∏ß‡∏∏‡∏í‡∏¥‡∏®‡∏±‡∏Å‡∏î‡∏¥‡πå", quota: { sick: 60, personal: 45, vacation: 10, used_sick: 0, used_personal: 0, used_vacation: 0 } },
            { id: "u002", rank: "‡∏ô.‡∏ó.‡∏´‡∏ç‡∏¥‡∏á", name: "‡∏Ç‡∏à‡∏£‡∏à‡∏¥‡∏ï‡∏ï‡πå ‡∏ä‡∏¥‡∏ì‡∏û‡∏á‡∏®‡πå", quota: { sick: 60, personal: 45, vacation: 10, used_sick: 0, used_personal: 0, used_vacation: 0 } },
            { id: "u003", rank: "‡∏ô.‡∏ï.", name: "‡∏ò‡∏ì‡∏Å‡∏£ ‡∏û‡∏∂‡πà‡∏á‡∏û‡∏¥‡∏°‡∏≤‡∏¢", quota: { sick: 60, personal: 45, vacation: 10, used_sick: 0, used_personal: 0, used_vacation: 0 } },
            { id: "u004", rank: "‡∏ô.‡∏ï.‡∏´‡∏ç‡∏¥‡∏á", name: "‡∏Å‡∏≤‡∏ô‡∏ï‡πå‡∏û‡∏¥‡∏ä‡∏ä‡∏≤ ‡πÄ‡∏ä‡∏≤‡∏ß‡∏•‡∏¥‡∏ï", quota: { sick: 60, personal: 45, vacation: 10, used_sick: 0, used_personal: 0, used_vacation: 0 } },
            { id: "u005", rank: "‡∏£.‡∏≠.‡∏´‡∏ç‡∏¥‡∏á", name: "‡∏£‡∏∏‡πà‡∏á‡∏ó‡∏¥‡∏ß‡∏≤ ‡∏£‡∏±‡∏ï‡∏ô‡πå‡∏≠‡πà‡∏≠‡∏ô", quota: { sick: 60, personal: 45, vacation: 10, used_sick: 0, used_personal: 0, used_vacation: 0 } },
            { id: "u006", rank: "‡∏£.‡∏≠.‡∏´‡∏ç‡∏¥‡∏á", name: "‡∏≠‡∏†‡∏¥‡∏£‡∏≤‡∏° ‡∏™‡∏ò‡∏ô‡∏Å‡∏∏‡∏•", quota: { sick: 60, personal: 45, vacation: 10, used_sick: 0, used_personal: 0, used_vacation: 0 } },
            { id: "u007", rank: "‡∏£.‡∏≠.‡∏´‡∏ç‡∏¥‡∏á", name: "‡∏ï‡∏£‡∏µ‡∏ê‡∏¥‡∏ï‡∏≤ ‡∏≠‡∏¥‡∏ô‡∏ó‡∏∞‡∏ä‡∏±‡∏¢", quota: { sick: 60, personal: 45, vacation: 10, used_sick: 0, used_personal: 0, used_vacation: 0 } },
            { id: "u008", rank: "‡∏û.‡∏≠.‡∏≠.", name: "‡∏ô‡∏û‡∏û‡∏£ ‡∏≠‡∏£‡∏∏‡∏ì‡∏â‡∏≤‡∏¢", quota: { sick: 60, personal: 45, vacation: 10, used_sick: 0, used_personal: 0, used_vacation: 0 } },
            { id: "u009", rank: "‡∏û.‡∏≠.‡∏≠.‡∏´‡∏ç‡∏¥‡∏á", name: "‡∏™‡∏∏‡∏ò‡∏¥‡∏°‡∏≤ ‡∏®‡∏¥‡∏£‡∏¥‡∏û‡∏¥‡∏û‡∏±‡∏í‡∏ô‡πå‡∏û‡∏á‡∏©‡πå", quota: { sick: 60, personal: 45, vacation: 10, used_sick: 0, used_personal: 0, used_vacation: 0 } },
            { id: "u010", rank: "‡∏û.‡∏≠.‡∏ï.", name: "‡∏†‡∏π‡∏£‡∏¥‡∏û‡∏á‡∏©‡πå ‡∏™‡∏•‡∏≤‡∏á‡∏™‡∏¥‡∏á‡∏´‡πå", quota: { sick: 60, personal: 45, vacation: 10, used_sick: 0, used_personal: 0, used_vacation: 0 } },
            { id: "u011", rank: "‡∏ô‡∏≤‡∏¢", name: "‡∏Å‡∏§‡∏©‡∏î‡∏≤ ‡∏Ñ‡∏á‡∏Å‡∏±‡∏•‡∏õ‡πå", quota: { sick: 60, personal: 45, vacation: 10, used_sick: 0, used_personal: 0, used_vacation: 0 } },
            { id: "u012", rank: "‡∏ô‡∏≤‡∏¢", name: "‡∏õ‡∏£‡∏∞‡πÄ‡∏™‡∏£‡∏¥‡∏ê ‡∏ó‡∏±‡∏ö‡πÅ‡∏ñ‡∏°", quota: { sick: 60, personal: 45, vacation: 10, used_sick: 0, used_personal: 0, used_vacation: 0 } },
            { id: "u013", rank: "‡∏ô.‡∏™.", name: "‡πÄ‡∏™‡∏≤‡∏ß‡∏ì‡∏µ‡∏¢‡πå ‡∏≠‡∏¥‡∏ô‡∏Å‡∏≤‡∏¢", quota: { sick: 60, personal: 45, vacation: 10, used_sick: 0, used_personal: 0, used_vacation: 0 } },
            { id: "u015", rank: "‡∏ô‡∏≤‡∏¢", name: "‡∏≠‡∏†‡∏¥‡∏£‡∏±‡∏Å‡∏©‡πå ‡∏ô‡∏¥‡∏•‡πÄ‡∏Å‡∏©‡∏°", quota: { sick: 60, personal: 45, vacation: 10, used_sick: 0, used_personal: 0, used_vacation: 0 } }
        ];

        let allUsers = [];
        let currentUser = null;

        // --- INIT SYSTEM ---
        async function initSystem() {
            try {
                const snapshot = await db.collection("users").get();
                if (snapshot.empty) {
                    const batch = db.batch();
                    initialUsers.forEach(u => batch.set(db.collection("users").doc(u.id), u));
                    await batch.commit();
                    allUsers = initialUsers;
                } else {
                    allUsers = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    // Sync logic omitted for brevity
                }
                document.getElementById('loading-screen').style.display = 'none';
                document.getElementById('screen-home').style.display = 'flex';
                renderUserList(allUsers);
            } catch (error) { alert("DB Error: " + error.message); }
        }

        // --- RENDER USERS ---
        function renderUserList(users) {
            const list = document.getElementById('userList');
            list.innerHTML = '';
            users.forEach(u => {
                const div = document.createElement('div');
                div.className = 'flex items-center p-3 rounded-xl cursor-pointer hover:bg-pink-50 transition border border-transparent hover:border-pink-200';
                div.onclick = () => selectUser(u);
                const color = ['bg-pink-200','bg-blue-200','bg-green-200','bg-yellow-200'][Math.floor(Math.random()*4)];
                div.innerHTML = `<div class="h-10 w-10 ${color} rounded-full flex items-center justify-center font-bold mr-3 text-gray-600">${u.name.charAt(0)}</div><div><div class="font-bold text-gray-700">${u.name}</div><div class="text-xs text-gray-400">${u.rank}</div></div>`;
                list.appendChild(div);
            });
        }
        function filterUsers() {
            const val = document.getElementById('searchInput').value;
            renderUserList(val ? allUsers.filter(u => u.name.includes(val) || u.rank.includes(val)) : allUsers);
        }
        async function selectUser(u) {
            currentUser = u;
            document.getElementById('loading-screen').style.display = 'flex';
            const doc = await db.collection("users").doc(u.id).get();
            currentUser = { id: doc.id, ...doc.data() };
            document.getElementById('user-fullname').innerText = `${currentUser.rank} ${currentUser.name}`;
            document.getElementById('user-initial').innerText = currentUser.name.charAt(0);
            updateQuotaUI();
            document.getElementById('loading-screen').style.display = 'none';
            document.getElementById('screen-home').style.display = 'none';
            document.getElementById('screen-dashboard').style.display = 'block';
            loadHistory(u.id);
        }
        function updateQuotaUI() {
            const q = currentUser.quota;
            document.getElementById('quota-sick').innerText = q.sick - q.used_sick;
            document.getElementById('quota-personal').innerText = q.personal - q.used_personal;
            document.getElementById('quota-vacation').innerText = q.vacation - q.used_vacation;
        }

        // --- PDF LOGIC ---
        async function generatePDF(user, type, start, end, reason, extra) {
            // Mapping File Name
            const fileMap = {
                'vacation': 'form_vacation.pdf',
                'sick': 'form_sick.pdf',
                'personal': 'form_personal.pdf',
                'ordination': 'form_ordination.pdf',
                'maternity': 'form_maternity.pdf',
                'help_wife': 'form_help_wife.pdf',
                'cancel': 'form_cancel.pdf'
            };

            const fontUrl = './Sarabun.ttf';
            const pdfUrl = './' + fileMap[type];

            try {
                const fontBytes = await fetch(fontUrl).then(res => {
                    if (!res.ok) throw new Error(`‡πÇ‡∏´‡∏•‡∏î‡∏ü‡∏≠‡∏ô‡∏ï‡πå‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à (${fontUrl})`);
                    return res.arrayBuffer();
                });
                const pdfBytes = await fetch(pdfUrl).then(res => {
                    if (!res.ok) throw new Error(`‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå PDF ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à (${pdfUrl})`);
                    return res.arrayBuffer();
                });

                const pdfDoc = await PDFLib.PDFDocument.load(pdfBytes);
                pdfDoc.registerFontkit(fontkit);
                const thaiFont = await pdfDoc.embedFont(fontBytes);
                const page = pdfDoc.getPages()[0];
                const draw = (text, x, y, size=16) => page.drawText(text || '', { x, y, size, font: thaiFont, color: PDFLib.rgb(0,0,0) });

                const dStart = new Date(start);
                const dEnd = new Date(end);
                const now = new Date();
                const days = Math.ceil(Math.abs(dEnd - dStart)/(1000*60*60*24))+1;

                // --- HEADER ---
                draw('‡∏Å‡∏≠‡∏á‡πÄ‡∏ß‡∏ä‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô ‡∏û‡∏≠.', 430, 755);
                draw(now.getDate().toString(), 450, 730);
                draw(formatMonth(now.getMonth()), 495, 730);
                draw((now.getFullYear()+543).toString(), 545, 730);
                draw('‡∏ú‡∏≠.‡∏Å‡∏ß‡∏õ.‡∏û‡∏≠.', 100, 690);
                draw(`${user.rank}${user.name}`, 180, 655);
                draw(user.rank, 380, 655);
                draw('‡∏Å‡∏ß‡∏õ.‡∏û‡∏≠.', 120, 630);

                // --- SPECIFIC FIELDS ---
                if (type === 'vacation') {
                    draw(days.toString(), 280, 580);
                    draw(dStart.getDate().toString(), 370, 580);
                    draw(formatMonth(dStart.getMonth()), 415, 580);
                    draw((dStart.getFullYear()+543).toString().slice(-2), 485, 580);
                    draw(reason, 230, 530);
                } 
                else if (type === 'sick') {
                    draw(reason, 180, 580);
                    draw(days.toString(), 250, 555);
                    draw(dStart.getDate().toString(), 360, 555);
                }

                const pdfBytesOut = await pdfDoc.save();
                const blob = new Blob([pdfBytesOut], { type: "application/pdf" });
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = `‡πÉ‡∏ö‡∏•‡∏≤_${type}_${user.name}.pdf`;
                link.click();
            } catch (err) {
                console.error(err);
                alert(`‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡∏ï‡∏≠‡∏ô‡∏™‡∏£‡πâ‡∏≤‡∏á PDF:\n${err.message}\n\n*‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå ${pdfUrl} ‡πÅ‡∏•‡∏∞ Sarabun.ttf ‡∏Ç‡∏∂‡πâ‡∏ô GitHub ‡∏´‡∏£‡∏∑‡∏≠‡∏¢‡∏±‡∏á?`);
                throw err; // Re-throw to stop process
            }
        }

        // --- DIAGNOSTICS TOOL ---
        async function runDiagnostics() {
            const log = document.getElementById('debug-log');
            log.innerHTML = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÑ‡∏ü‡∏•‡πå...\n";
            
            const checkFile = async (url) => {
                try {
                    const res = await fetch(url, { method: 'HEAD' });
                    return res.ok ? "‚úÖ ‡πÄ‡∏à‡∏≠" : "‚ùå ‡πÑ‡∏°‡πà‡πÄ‡∏à‡∏≠ (404)";
                } catch (e) { return "‚ùå Error"; }
            };

            const fontStatus = await checkFile('./Sarabun.ttf');
            log.innerHTML += `1. Font (Sarabun.ttf): ${fontStatus}\n`;

            const pdfStatus = await checkFile('./form_vacation.pdf');
            log.innerHTML += `2. PDF (form_vacation.pdf): ${pdfStatus}\n`;

            if(fontStatus.includes('‚ùå') || pdfStatus.includes('‚ùå')) {
                log.innerHTML += "\n‚ö†Ô∏è ‡∏™‡∏£‡∏∏‡∏õ: ‡πÑ‡∏ü‡∏•‡πå‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö‡∏Ñ‡∏£‡∏±‡∏ö ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡∏∂‡πâ‡∏ô GitHub";
            } else {
                log.innerHTML += "\n‚úÖ ‡∏™‡∏£‡∏∏‡∏õ: ‡πÑ‡∏ü‡∏•‡πå‡∏Ñ‡∏£‡∏ö‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô!";
            }
        }

        // --- HELPERS ---
        function formatMonth(m) { return ['‡∏°.‡∏Ñ.','‡∏Å.‡∏û.','‡∏°‡∏µ.‡∏Ñ.','‡πÄ‡∏°.‡∏¢.','‡∏û.‡∏Ñ.','‡∏°‡∏¥.‡∏¢.','‡∏Å.‡∏Ñ.','‡∏™.‡∏Ñ.','‡∏Å.‡∏¢.','‡∏ï.‡∏Ñ.','‡∏û.‡∏¢.','‡∏ò.‡∏Ñ.'][m]; }
        
        async function handleSaveAndPrint(e) {
            e.preventDefault();
            const btn = document.getElementById('btn-submit');
            const originalText = btn.innerHTML; // ‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏î‡∏¥‡∏°
            btn.innerHTML = "‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ó‡∏≥‡∏á‡∏≤‡∏ô..."; 
            btn.disabled = true;

            const type = document.getElementById('leaveType').value;
            const start = document.getElementById('startDate').value;
            const end = document.getElementById('endDate').value;
            const reason = document.getElementById('reason').value;
            const days = Math.ceil(Math.abs(new Date(end) - new Date(start))/(1000*60*60*24))+1;

            try {
                // 1. Generate PDF First (‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå‡πÉ‡∏´‡πâ‡πÄ‡∏™‡∏£‡πá‡∏à‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏ã‡∏ü‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•)
                await generatePDF(currentUser, type, start, end, reason, {});
                
                // 2. Save to DB
                await db.collection("leave_records").add({
                    userId: currentUser.id, userName: currentUser.name,
                    leaveType: type, startDate: start, endDate: end, totalDays: days, reason,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                });

                // 3. Update Quota
                const userRef = db.collection("users").doc(currentUser.id);
                let field = null;
                if(type === 'sick') field = 'quota.used_sick';
                if(type === 'personal') field = 'quota.used_personal';
                if(type === 'vacation') field = 'quota.used_vacation';
                
                if(field) await userRef.update({ [field]: firebase.firestore.FieldValue.increment(days) });

                alert("‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢! ‡πÑ‡∏ü‡∏•‡πå PDF ‡∏Ñ‡∏ß‡∏£‡∏à‡∏∞‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡∏Ñ‡∏£‡∏±‡∏ö");
                
                // **‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç**: ‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πâ location.reload() ‡πÅ‡∏ï‡πà‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡∏ü‡∏≠‡∏£‡πå‡∏°‡πÅ‡∏ó‡∏ô
                document.getElementById('leaveForm').reset();
                btn.innerHTML = originalText;
                btn.disabled = false;
                
                // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏•‡∏≤‡∏ó‡∏µ‡πà‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
                loadHistory(currentUser.id);
                
            } catch (err) {
                // Error handled
                alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: " + err.message);
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        }

        function toggleFields() {
            const type = document.getElementById('leaveType').value;
            const isCancel = type === 'cancel';
            document.getElementById('cancelSection').style.display = isCancel ? 'block' : 'none';
        }
        function switchTab(t) {
            document.getElementById('tab-request').style.display = t === 'request' ? 'block' : 'none';
            document.getElementById('tab-history').style.display = t === 'history' ? 'block' : 'none';
        }
        async function loadHistory(uid) {
            const l = document.getElementById('historyList'); l.innerHTML = '';
            const s = await db.collection("leave_records").where("userId","==",uid).orderBy("timestamp","desc").limit(5).get();
            if(s.empty) l.innerHTML = '<li class="text-center text-gray-400 py-4">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏Ñ‡∏¢‡∏•‡∏≤</li>';
            s.forEach(d => {
                const data = d.data();
                l.innerHTML += `<li class="p-3 border rounded-xl flex justify-between bg-white"><div><div class="font-bold text-gray-700">${data.leaveType}</div><div class="text-xs text-gray-400">${data.startDate} (${data.totalDays} ‡∏ß‡∏±‡∏ô)</div></div></li>`;
            });
        }
        function goHome() { location.reload(); }

        initSystem();
    </script>
</body>
</html>
