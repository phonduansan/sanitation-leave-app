<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏£‡∏∞‡∏ö‡∏ö‡∏•‡∏≤‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå (‡πÅ‡∏ú‡∏ô‡∏Å‡∏™‡∏∏‡∏Ç‡∏≤‡∏†‡∏¥‡∏ö‡∏≤‡∏•)</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;600&display=swap" rel="stylesheet">
    
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>

    <script src="https://unpkg.com/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>
    <script src="https://unpkg.com/@pdf-lib/fontkit@0.0.4/dist/fontkit.umd.min.js"></script>

    <style>
        body { font-family: 'Sarabun', sans-serif; }
        .hidden-section { display: none; }
        .loader { border-top-color: #3498db; -webkit-animation: spinner 1.5s linear infinite; animation: spinner 1.5s linear infinite; }
        @keyframes spinner { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">

    <div id="loading-screen" class="fixed inset-0 bg-white z-50 flex flex-col items-center justify-center">
        <div class="loader ease-linear rounded-full border-8 border-t-8 border-gray-200 h-16 w-16 mb-4"></div>
        <p class="text-gray-500 text-xl font-bold">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</p>
    </div>

    <div id="screen-home" class="container mx-auto px-4 py-10 max-w-2xl hidden-section">
        <div class="text-center mb-10">
            <h1 class="text-3xl font-bold text-blue-800">‡∏£‡∏∞‡∏ö‡∏ö‡∏•‡∏≤‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå</h1>
            <p class="text-gray-600 mt-2">‡πÅ‡∏ú‡∏ô‡∏Å‡∏™‡∏∏‡∏Ç‡∏≤‡∏†‡∏¥‡∏ö‡∏≤‡∏• ‡∏Å‡∏≠‡∏á‡πÄ‡∏ß‡∏ä‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô ‡∏Å‡∏£‡∏°‡πÅ‡∏û‡∏ó‡∏¢‡πå‡∏ó‡∏´‡∏≤‡∏£‡∏≠‡∏≤‡∏Å‡∏≤‡∏®</p>
        </div>

        <div class="mb-6 relative">
            <input type="text" id="searchInput" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤..." 
                   class="w-full p-4 text-xl border-2 border-blue-300 rounded-lg shadow-sm focus:outline-none focus:border-blue-500"
                   onkeyup="filterUsers()">
        </div>

        <div id="userList" class="grid gap-3 max-h-96 overflow-y-auto">
            </div>
    </div>

    <div id="screen-dashboard" class="hidden-section container mx-auto px-4 py-6 max-w-4xl">
        <div class="flex justify-between items-center bg-white p-4 rounded-lg shadow mb-6">
            <div class="flex items-center">
                <div class="h-12 w-12 bg-blue-600 rounded-full flex items-center justify-center text-white text-xl font-bold mr-4">
                    <span id="user-initial">?</span>
                </div>
                <div>
                    <h2 id="user-fullname" class="text-xl font-bold text-gray-800">...</h2>
                    <p id="user-rank" class="text-gray-500 text-sm">...</p>
                </div>
            </div>
            <button onclick="goHome()" class="text-red-500 border border-red-500 px-4 py-2 rounded hover:bg-red-50">‡∏≠‡∏≠‡∏Å</button>
        </div>

        <div class="flex mb-6 border-b border-gray-300">
            <button onclick="switchTab('request')" id="btn-tab-request" class="w-1/2 py-3 text-center text-blue-600 border-b-2 border-blue-600 font-bold bg-white">üìù ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡πÉ‡∏ö‡∏•‡∏≤</button>
            <button onclick="switchTab('history')" id="btn-tab-history" class="w-1/2 py-3 text-center text-gray-500 font-bold bg-gray-50">üìä ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡∏±‡∏ô‡∏•‡∏≤</button>
        </div>

        <div id="tab-request">
            <div class="bg-white p-6 rounded-lg shadow">
                <form id="leaveForm" onsubmit="handleSaveAndPrint(event)">
                    <div class="mb-4">
                        <label class="block text-gray-700 font-bold mb-2">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Å‡∏≤‡∏£‡∏•‡∏≤</label>
                        <select id="leaveType" class="w-full p-3 border rounded-lg bg-gray-50" onchange="toggleFields()">
                            <option value="sick">‡∏•‡∏≤‡∏õ‡πà‡∏ß‡∏¢ (‡πÅ‡∏ö‡∏ö ‡πì)</option>
                            <option value="personal">‡∏•‡∏≤‡∏Å‡∏¥‡∏à (‡πÅ‡∏ö‡∏ö ‡πñ)</option>
                            <option value="vacation">‡∏•‡∏≤‡∏û‡∏±‡∏Å‡∏ú‡πà‡∏≠‡∏ô (‡πÅ‡∏ö‡∏ö ‡πó)</option>
                            <option value="ordination">‡∏•‡∏≤‡∏≠‡∏∏‡∏õ‡∏™‡∏°‡∏ö‡∏ó (‡πÅ‡∏ö‡∏ö ‡πò)</option>
                            <option value="maternity">‡∏•‡∏≤‡∏Ñ‡∏•‡∏≠‡∏î‡∏ö‡∏∏‡∏ï‡∏£ (‡πÅ‡∏ö‡∏ö ‡πî)</option>
                            <option value="help_wife">‡∏•‡∏≤‡∏ä‡πà‡∏ß‡∏¢‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏†‡∏£‡∏¥‡∏¢‡∏≤‡∏Ñ‡∏•‡∏≠‡∏î‡∏ö‡∏∏‡∏ï‡∏£ (‡πÅ‡∏ö‡∏ö ‡πï)</option>
                            <option value="cancel">‡∏Ç‡∏≠‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏ß‡∏±‡∏ô‡∏•‡∏≤ (‡πÅ‡∏ö‡∏ö ‡πë‡πñ)</option>
                        </select>
                    </div>

                    <div class="grid grid-cols-2 gap-4 mb-4">
                        <div>
                            <label class="block text-gray-700 mb-1">‡∏ï‡∏±‡πâ‡∏á‡πÅ‡∏ï‡πà‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</label>
                            <input type="date" id="startDate" class="w-full p-3 border rounded-lg" required>
                        </div>
                        <div>
                            <label class="block text-gray-700 mb-1">‡∏ñ‡∏∂‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</label>
                            <input type="date" id="endDate" class="w-full p-3 border rounded-lg" required>
                        </div>
                    </div>

                    <div class="mb-4">
                        <label id="reasonLabel" class="block text-gray-700 mb-1">‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏• / ‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠</label>
                        <textarea id="reason" rows="2" class="w-full p-3 border rounded-lg" placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î..."></textarea>
                    </div>

                    <button type="submit" id="btn-submit" class="w-full bg-blue-600 text-white text-xl py-4 rounded-lg font-bold shadow hover:bg-blue-700 transition">
                        üñ®Ô∏è ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡∏∞‡∏û‡∏¥‡∏°‡∏û‡πå‡πÉ‡∏ö‡∏•‡∏≤
                    </button>
                </form>
            </div>
        </div>

        <div id="tab-history" class="hidden-section">
            <div class="grid grid-cols-3 gap-4 mb-6">
                <div class="bg-red-50 p-4 rounded text-center border border-red-200">
                    <p class="text-sm text-red-800">‡∏õ‡πà‡∏ß‡∏¢‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠</p>
                    <p class="text-2xl font-bold" id="quota-sick">0</p>
                </div>
                <div class="bg-yellow-50 p-4 rounded text-center border border-yellow-200">
                    <p class="text-sm text-yellow-800">‡∏Å‡∏¥‡∏à‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠</p>
                    <p class="text-2xl font-bold" id="quota-personal">0</p>
                </div>
                <div class="bg-green-50 p-4 rounded text-center border border-green-200">
                    <p class="text-sm text-green-800">‡∏û‡∏±‡∏Å‡∏£‡πâ‡∏≠‡∏ô‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠</p>
                    <p class="text-2xl font-bold" id="quota-vacation">0</p>
                </div>
            </div>
            
            <div class="bg-white rounded-lg shadow p-4">
                <h3 class="font-bold mb-3">‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏•‡∏≤‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</h3>
                <ul id="historyList" class="divide-y text-sm">
                    <li class="py-2 text-gray-500 text-center">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏•‡∏≤</li>
                </ul>
            </div>
        </div>
    </div>

    <script>
        // --- 1. CONFIGURATION ---
        const firebaseConfig = {
            apiKey: "AIzaSyAxgj4sKMUdMQJWj2hU2rbcT4eZ926sskQ",
            authDomain: "leave-system-online.firebaseapp.com",
            projectId: "leave-system-online",
            storageBucket: "leave-system-online.firebasestorage.app",
            messagingSenderId: "801381918860",
            appId: "1:801381918860:web:035197d704d8e6712f73a9",
            measurementId: "G-D4P9EB6K7H"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        // --- 2. DATA PREPARATION (‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô) ---
        const initialUsers = [
            { id: "u001", rank: "‡∏ô.‡∏ó.‡∏´‡∏ç‡∏¥‡∏á", name: "‡∏û‡∏±‡∏ä‡∏£‡∏¥‡∏ô‡∏ó‡∏£‡πå ‡∏ß‡∏á‡∏©‡πå‡∏ß‡∏∏‡∏í‡∏¥‡∏®‡∏±‡∏Å‡∏î‡∏¥‡πå", quota: { sick: 60, personal: 45, vacation: 10, used_sick: 0, used_personal: 0, used_vacation: 0 } },
            { id: "u002", rank: "‡∏ô.‡∏ó.‡∏´‡∏ç‡∏¥‡∏á", name: "‡∏Ç‡∏à‡∏£‡∏à‡∏¥‡∏ï‡∏ï‡πå ‡∏ä‡∏¥‡∏ì‡∏û‡∏á‡∏®‡πå", quota: { sick: 60, personal: 45, vacation: 10, used_sick: 0, used_personal: 0, used_vacation: 0 } },
            { id: "u003", rank: "‡∏ô.‡∏ï.", name: "‡∏ò‡∏ì‡∏Å‡∏£ ‡∏û‡∏∂‡πà‡∏á‡∏û‡∏¥‡∏°‡∏≤‡∏¢", quota: { sick: 60, personal: 45, vacation: 10, used_sick: 0, used_personal: 0, used_vacation: 0 } },
            { id: "u004", rank: "‡∏ô.‡∏ï.‡∏´‡∏ç‡∏¥‡∏á", name: "‡∏Å‡∏≤‡∏ô‡∏ï‡πå‡∏û‡∏¥‡∏ä‡∏ä‡∏≤ ‡πÄ‡∏ä‡∏≤‡∏ß‡∏•‡∏¥‡∏ï", quota: { sick: 60, personal: 45, vacation: 10, used_sick: 0, used_personal: 0, used_vacation: 0 } },
            { id: "u005", rank: "‡∏£.‡∏≠.‡∏´‡∏ç‡∏¥‡∏á", name: "‡∏£‡∏∏‡πà‡∏á‡∏ó‡∏¥‡∏ß‡∏≤ ‡∏£‡∏±‡∏ï‡∏ô‡πå‡∏≠‡πà‡∏≠‡∏ô", quota: { sick: 60, personal: 45, vacation: 10, used_sick: 0, used_personal: 0, used_vacation: 0 } },
            { id: "u006", rank: "‡∏£.‡∏≠.‡∏´‡∏ç‡∏¥‡∏á", name: "‡∏≠‡∏†‡∏¥‡∏£‡∏≤‡∏° ‡∏™‡∏ò‡∏ô‡∏Å‡∏∏‡∏•", quota: { sick: 60, personal: 45, vacation: 10, used_sick: 0, used_personal: 0, used_vacation: 0 } },
            { id: "u007", rank: "‡∏£.‡∏≠.‡∏´‡∏ç‡∏¥‡∏á", name: "‡∏ï‡∏£‡∏µ‡∏ê‡∏¥‡∏ï‡∏≤ ‡∏≠‡∏¥‡∏ô‡∏ó‡∏∞‡∏ä‡∏±‡∏¢", quota: { sick: 60, personal: 45, vacation: 10, used_sick: 0, used_personal: 0, used_vacation: 0 } },
            { id: "u008", rank: "‡∏û.‡∏≠.‡∏≠.", name: "‡∏ô‡∏û‡∏û‡∏£ ‡∏≠‡∏£‡∏∏‡∏ì‡∏â‡∏≤‡∏¢", quota: { sick: 60, personal: 45, vacation: 10, used_sick: 0, used_personal: 0, used_vacation: 0 } },
            { id: "u009", rank: "‡∏û.‡∏≠.‡∏≠.‡∏´‡∏ç‡∏¥‡∏á", name: "‡∏™‡∏∏‡∏ò‡∏¥‡∏°‡∏≤ ‡∏®‡∏¥‡∏£‡∏¥‡∏û‡∏¥‡∏û‡∏±‡∏í‡∏ô‡πå‡∏û‡∏á‡∏©‡πå", quota: { sick: 60, personal: 45, vacation: 10, used_sick: 0, used_personal: 0, used_vacation: 0 } },
            { id: "u010", rank: "‡∏û.‡∏≠.‡∏ï.", name: "‡∏†‡∏π‡∏£‡∏¥‡∏û‡∏á‡∏©‡πå ‡∏™‡∏•‡∏≤‡∏á‡∏™‡∏¥‡∏á‡∏´‡πå", quota: { sick: 60, personal: 45, vacation: 10, used_sick: 0, used_personal: 0, used_vacation: 0 } },
            { id: "u011", rank: "‡∏ô‡∏≤‡∏¢", name: "‡∏Å‡∏§‡∏©‡∏î‡∏≤ ‡∏Ñ‡∏á‡∏Å‡∏±‡∏•‡∏õ‡πå", quota: { sick: 60, personal: 45, vacation: 10, used_sick: 0, used_personal: 0, used_vacation: 0 } },
            { id: "u012", rank: "‡∏ô‡∏≤‡∏¢", name: "‡∏õ‡∏£‡∏∞‡πÄ‡∏™‡∏£‡∏¥‡∏ê ‡∏ó‡∏±‡∏ö‡πÅ‡∏ñ‡∏°", quota: { sick: 60, personal: 45, vacation: 10, used_sick: 0, used_personal: 0, used_vacation: 0 } },
            { id: "u013", rank: "‡∏ô.‡∏™.", name: "‡πÄ‡∏™‡∏≤‡∏ß‡∏ì‡∏µ‡∏¢‡πå ‡∏≠‡∏¥‡∏ô‡∏Å‡∏≤‡∏¢", quota: { sick: 60, personal: 45, vacation: 10, used_sick: 0, used_personal: 0, used_vacation: 0 } }
        ];

        let allUsers = [];
        let currentUser = null;

        // --- 3. CORE FUNCTIONS ---

        // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö: ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô Firebase ‡∏´‡∏£‡∏∑‡∏≠‡∏¢‡∏±‡∏á ‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡πÉ‡∏´‡πâ Upload ‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏Ç‡∏∂‡πâ‡∏ô‡πÑ‡∏õ
        async function initSystem() {
            try {
                const snapshot = await db.collection("users").get();
                if (snapshot.empty) {
                    console.log("Database Empty. Uploading initial users...");
                    const batch = db.batch();
                    initialUsers.forEach((user) => {
                        const docRef = db.collection("users").doc(user.id);
                        batch.set(docRef, user);
                    });
                    await batch.commit();
                    console.log("Upload Complete!");
                    allUsers = initialUsers;
                } else {
                    console.log("Database Ready. Loading users...");
                    allUsers = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                }
                
                // ‡∏ã‡πà‡∏≠‡∏ô Loading ‡πÅ‡∏™‡∏î‡∏á Home
                document.getElementById('loading-screen').style.display = 'none';
                document.getElementById('screen-home').style.display = 'block';
                renderUserList(allUsers);

            } catch (error) {
                alert("Error connecting to database: " + error.message);
            }
        }

        function renderUserList(users) {
            const list = document.getElementById('userList');
            list.innerHTML = '';
            users.forEach(u => {
                const div = document.createElement('div');
                div.className = 'bg-white p-4 rounded shadow cursor-pointer hover:bg-blue-50 border border-gray-200';
                div.innerHTML = `<span class="font-bold text-lg text-gray-800">${u.rank} ${u.name}</span>`;
                div.onclick = () => selectUser(u);
                list.appendChild(div);
            });
        }

        function filterUsers() {
            const input = document.getElementById('searchInput').value;
            if(input.length < 1) {
                renderUserList([]); // Clear if empty
                return;
            }
            const filtered = allUsers.filter(u => u.name.includes(input) || u.rank.includes(input));
            renderUserList(filtered);
        }

        async function selectUser(user) {
            currentUser = user;
            // ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡∏à‡∏≤‡∏Å DB ‡∏≠‡∏µ‡∏Å‡∏ó‡∏µ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ä‡∏±‡∏ß‡∏£‡πå (Real-time)
            document.getElementById('loading-screen').style.display = 'flex';
            const doc = await db.collection("users").doc(user.id).get();
            currentUser = { id: doc.id, ...doc.data() };

            // Update UI
            document.getElementById('user-fullname').innerText = `${currentUser.rank} ${currentUser.name}`;
            document.getElementById('user-initial').innerText = currentUser.name.charAt(0);
            document.getElementById('user-rank').innerText = "‡πÅ‡∏ú‡∏ô‡∏Å‡∏™‡∏∏‡∏Ç‡∏≤‡∏†‡∏¥‡∏ö‡∏≤‡∏•"; // ‡∏´‡∏£‡∏∑‡∏≠‡∏î‡∏∂‡∏á‡∏à‡∏≤‡∏Å DB

            // Update Quota
            updateQuotaUI();
            
            // Switch Screen
            document.getElementById('loading-screen').style.display = 'none';
            document.getElementById('screen-home').style.display = 'none';
            document.getElementById('screen-dashboard').style.display = 'block';
            
            // Load History
            loadHistory(user.id);
        }

        function updateQuotaUI() {
            const q = currentUser.quota;
            document.getElementById('quota-sick').innerText = q.sick - q.used_sick;
            document.getElementById('quota-personal').innerText = q.personal - q.used_personal;
            document.getElementById('quota-vacation').innerText = q.vacation - q.used_vacation;
        }

        async function loadHistory(userId) {
            const list = document.getElementById('historyList');
            list.innerHTML = '<li class="py-2 text-center">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</li>';
            
            const snapshot = await db.collection("leave_records")
                                     .where("userId", "==", userId)
                                     .orderBy("timestamp", "desc")
                                     .limit(5)
                                     .get();
            
            list.innerHTML = '';
            if (snapshot.empty) {
                list.innerHTML = '<li class="py-2 text-gray-500 text-center">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏•‡∏≤</li>';
                return;
            }

            snapshot.forEach(doc => {
                const data = doc.data();
                const li = document.createElement('li');
                li.className = "py-3 border-b flex justify-between";
                li.innerHTML = `
                    <div>
                        <span class="font-bold text-gray-700">${translateType(data.leaveType)}</span>
                        <br><span class="text-xs text-gray-500">${data.startDate} (${data.totalDays} ‡∏ß‡∏±‡∏ô)</span>
                    </div>
                    <span class="text-xs bg-green-100 text-green-800 px-2 py-1 rounded h-fit">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡πâ‡∏ß</span>
                `;
                list.appendChild(li);
            });
        }

        async function handleSaveAndPrint(e) {
            e.preventDefault();
            if(!confirm("‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á ‡πÅ‡∏•‡∏∞‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏û‡∏¥‡∏°‡∏û‡πå‡πÉ‡∏ö‡∏•‡∏≤?")) return;

            const btn = document.getElementById('btn-submit');
            btn.innerText = "‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...";
            btn.disabled = true;

            const leaveType = document.getElementById('leaveType').value;
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;
            const reason = document.getElementById('reason').value;

            // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏ß‡∏±‡∏ô (‡∏Ñ‡∏£‡πà‡∏≤‡∏ß‡πÜ)
            const start = new Date(startDate);
            const end = new Date(endDate);
            const diffTime = Math.abs(end - start);
            const totalDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)) + 1; 

            try {
                // 1. Save to History
                await db.collection("leave_records").add({
                    userId: currentUser.id,
                    userName: currentUser.name,
                    leaveType: leaveType,
                    startDate: startDate,
                    endDate: endDate,
                    totalDays: totalDays,
                    reason: reason,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                });

                // 2. Update Quota (‡∏ï‡∏±‡∏î‡∏ß‡∏±‡∏ô‡∏•‡∏≤)
                const userRef = db.collection("users").doc(currentUser.id);
                const updateField = {};
                if(leaveType === 'sick') updateField['quota.used_sick'] = firebase.firestore.FieldValue.increment(totalDays);
                if(leaveType === 'personal') updateField['quota.used_personal'] = firebase.firestore.FieldValue.increment(totalDays);
                if(leaveType === 'vacation') updateField['quota.used_vacation'] = firebase.firestore.FieldValue.increment(totalDays);
                
                if(Object.keys(updateField).length > 0) {
                    await userRef.update(updateField);
                }

                alert("‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÑ‡∏ü‡∏•‡πå PDF ‡πÉ‡∏ô‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏ï‡πà‡∏≠‡πÑ‡∏õ...");
                
                // 3. Generate PDF (Placeholder)
                // ‡πÉ‡∏ô‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ‡πÄ‡∏£‡∏≤‡∏à‡∏∞‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏£‡πâ‡∏≤‡∏á PDF (‡∏à‡∏∞‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÉ‡∏ô‡∏™‡πÄ‡∏ï‡πá‡∏õ‡∏ñ‡∏±‡∏î‡πÑ‡∏õ)
                // generatePDF(currentUser, leaveType, startDate, endDate, reason);

                location.reload(); // ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÉ‡∏´‡∏°‡πà

            } catch (error) {
                console.error(error);
                alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: " + error.message);
                btn.innerText = "‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á";
                btn.disabled = false;
            }
        }

        // --- Helpers ---
        function translateType(type) {
            const dict = { sick: "‡∏•‡∏≤‡∏õ‡πà‡∏ß‡∏¢", personal: "‡∏•‡∏≤‡∏Å‡∏¥‡∏à", vacation: "‡∏•‡∏≤‡∏û‡∏±‡∏Å‡∏£‡πâ‡∏≠‡∏ô", ordination: "‡∏•‡∏≤‡∏ö‡∏ß‡∏ä", maternity: "‡∏•‡∏≤‡∏Ñ‡∏•‡∏≠‡∏î", help_wife: "‡∏•‡∏≤‡∏ä‡πà‡∏ß‡∏¢‡∏†‡∏£‡∏¥‡∏¢‡∏≤", cancel: "‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏ß‡∏±‡∏ô‡∏•‡∏≤" };
            return dict[type] || type;
        }

        function toggleFields() {
            const type = document.getElementById('leaveType').value;
            const label = document.getElementById('reasonLabel');
            const ph = document.getElementById('reason');
            
            if(type === 'sick') { label.innerText = "‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡∏õ‡πà‡∏ß‡∏¢ / ‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡∏Ç‡∏ì‡∏∞‡∏•‡∏≤"; ph.placeholder = "‡∏õ‡πà‡∏ß‡∏¢‡πÄ‡∏õ‡πá‡∏ô‡πÑ‡∏Ç‡πâ‡∏´‡∏ß‡∏±‡∏î ‡∏û‡∏±‡∏Å‡∏ó‡∏µ‡πà..."; }
            else if(type === 'personal') { label.innerText = "‡∏Å‡∏¥‡∏à‡∏ò‡∏∏‡∏£‡∏∞ / ‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î‡∏ó‡∏µ‡πà‡∏à‡∏∞‡πÑ‡∏õ"; ph.placeholder = "‡∏ó‡∏≥‡∏ò‡∏∏‡∏£‡∏∞‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß ‡πÑ‡∏õ‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î..."; }
            else { label.innerText = "‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏• / ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏"; ph.placeholder = "..."; }
        }

        function goHome() { location.reload(); }
        
        function switchTab(tab) {
            document.getElementById('tab-request').style.display = tab === 'request' ? 'block' : 'none';
            document.getElementById('tab-history').style.display = tab === 'history' ? 'block' : 'none';
            // (Style switching logic omitted for brevity)
        }

        // Run System
        initSystem();

    </script>
</body>
</html>
