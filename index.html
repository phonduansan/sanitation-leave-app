<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏£‡∏∞‡∏ö‡∏ö‡∏•‡∏≤‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå (Sanitation Dept.)</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;600;800&display=swap" rel="stylesheet">
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
    <script src="https://unpkg.com/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>
    <script src="https://unpkg.com/@pdf-lib/fontkit@0.0.4/dist/fontkit.umd.min.js"></script>

    <style>
        body { font-family: 'Sarabun', sans-serif; background: linear-gradient(135deg, #fdfbf7 0%, #eef2f3 100%); }
        .pastel-card { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); border-radius: 20px; box-shadow: 0 10px 30px -5px rgba(0, 0, 0, 0.05); border: 1px solid rgba(255, 255, 255, 0.5); }
        .hidden-section { display: none; }
        .loader { border: 4px solid #f3f3f3; border-radius: 50%; border-top: 4px solid #3498db; width: 40px; height: 40px; animation: spin 2s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="text-gray-700">

    <div id="loading-screen" class="fixed inset-0 bg-pink-50 z-50 flex flex-col items-center justify-center">
        <div class="loader mb-4"></div>
        <p class="text-pink-400 text-xl font-bold animate-pulse">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</p>
    </div>

    <!-- Home -->
    <div id="screen-home" class="min-h-screen flex flex-col items-center justify-center px-4 py-10 hidden-section bg-gradient-to-b from-pink-50 to-blue-50">
        <div class="text-center mb-8">
            <div class="text-6xl mb-2">üè•‚ú®</div>
            <h1 class="text-3xl font-extrabold text-gray-700">‡∏£‡∏∞‡∏ö‡∏ö‡πÉ‡∏ö‡∏•‡∏≤‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå</h1>
            <p class="text-gray-500 mt-2">‡πÅ‡∏ú‡∏ô‡∏Å‡∏™‡∏∏‡∏Ç‡∏≤‡∏†‡∏¥‡∏ö‡∏≤‡∏• ‡∏Å‡∏≠‡∏á‡πÄ‡∏ß‡∏ä‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô ‡∏Å‡∏£‡∏°‡πÅ‡∏û‡∏ó‡∏¢‡πå‡∏ó‡∏´‡∏≤‡∏£‡∏≠‡∏≤‡∏Å‡∏≤‡∏®</p>
        </div>
        <div class="w-full max-w-md pastel-card p-6">
            <label class="block text-gray-600 font-bold mb-3 ml-1">üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ä‡∏∑‡πà‡∏≠</label>
            <input type="text" id="searchInput" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ä‡∏∑‡πà‡∏≠..." class="w-full pl-4 p-4 rounded-xl bg-gray-50 border-2 border-pink-100 focus:outline-none focus:ring-2 focus:ring-pink-200 mb-4" onkeyup="filterUsers()">
            <div id="userList" class="h-64 overflow-y-auto space-y-2 pr-2"></div>
        </div>
        <div class="mt-4 text-xs text-gray-400 text-center">ver. 3.1 (Exact Coordinates)</div>
    </div>

    <!-- Dashboard -->
    <div id="screen-dashboard" class="hidden-section min-h-screen bg-gray-50 pb-10">
        <div class="bg-white rounded-b-3xl shadow-sm p-6 mb-6">
            <div class="flex justify-between items-start">
                <div>
                    <h2 id="user-fullname" class="text-xl font-bold text-gray-800">...</h2>
                    <span class="inline-block bg-blue-100 text-blue-600 text-xs px-2 py-1 rounded-full font-bold mt-1">‡∏ú‡∏™‡∏†.‡∏Å‡∏ß‡∏õ.‡∏û‡∏≠.</span>
                </div>
                <button onclick="location.reload()" class="text-red-500 border border-red-500 px-3 py-1 rounded">‡∏≠‡∏≠‡∏Å</button>
            </div>
        </div>

        <div class="container mx-auto px-4 max-w-2xl">
            <div class="pastel-card p-6 bg-white mb-6">
                
                <!-- TABS -->
                <div class="flex border-b border-gray-200 mb-6">
                    <button onclick="switchTab('request')" id="tab-btn-request" class="flex-1 py-2 font-bold text-blue-600 border-b-2 border-blue-600">üìù ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡πÉ‡∏ö‡∏•‡∏≤</button>
                    <button onclick="switchTab('history')" id="tab-btn-history" class="flex-1 py-2 font-bold text-gray-400 hover:text-gray-600">üïí ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏•‡∏≤</button>
                </div>

                <!-- FORM SECTION -->
                <div id="section-request">
                    <form id="leaveForm" onsubmit="handleSaveAndPrint(event)">
                        
                        <div class="mb-4">
                            <label class="block text-gray-700 font-bold mb-2">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Å‡∏≤‡∏£‡∏•‡∏≤</label>
                            <select id="leaveType" class="w-full p-3 rounded-lg border bg-gray-50">
                                <option value="vacation">üèñÔ∏è ‡∏•‡∏≤‡∏û‡∏±‡∏Å‡∏ú‡πà‡∏≠‡∏ô (‡πÅ‡∏ö‡∏ö ‡πó)</option>
                                <option value="sick">üò∑ ‡∏•‡∏≤‡∏õ‡πà‡∏ß‡∏¢ (‡πÅ‡∏ö‡∏ö ‡πì)</option>
                                <option value="personal">üöó ‡∏•‡∏≤‡∏Å‡∏¥‡∏à (‡πÅ‡∏ö‡∏ö ‡πñ)</option>
                                <option value="ordination">üôè ‡∏•‡∏≤‡∏≠‡∏∏‡∏õ‡∏™‡∏°‡∏ö‡∏ó (‡πÅ‡∏ö‡∏ö ‡πò)</option>
                                <option value="maternity">üë∂ ‡∏•‡∏≤‡∏Ñ‡∏•‡∏≠‡∏î‡∏ö‡∏∏‡∏ï‡∏£ (‡πÅ‡∏ö‡∏ö ‡πî)</option>
                                <option value="help_wife">üë®‚Äçüçº ‡∏•‡∏≤‡∏ä‡πà‡∏ß‡∏¢‡∏†‡∏£‡∏¥‡∏¢‡∏≤‡∏Ñ‡∏•‡∏≠‡∏î (‡πÅ‡∏ö‡∏ö ‡πï)</option>
                                <option value="cancel" class="text-red-600 font-bold">‚ùå ‡∏Ç‡∏≠‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏ß‡∏±‡∏ô‡∏•‡∏≤ (‡πÅ‡∏ö‡∏ö ‡πë‡πñ)</option>
                            </select>
                        </div>

                        <!-- ‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á (Auto-filled) -->
                        <div class="mb-4">
                            <label class="block text-gray-700 font-bold mb-2">‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á</label>
                            <input type="text" id="userPosition" class="w-full p-3 rounded-lg border bg-blue-50 text-gray-600" placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì..." readonly>
                        </div>

                        <div class="mb-4">
                            <label class="block text-gray-700 font-bold mb-2">‡πÄ‡∏£‡∏µ‡∏¢‡∏ô (‡∏ú‡∏π‡πâ‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡∏ö‡∏±‡∏ç‡∏ä‡∏≤)</label>
                            <select id="toWhom" class="w-full p-3 rounded-lg border bg-gray-50">
                                <option value="head">‡∏´‡∏ô.‡∏ú‡∏™‡∏†.‡∏Å‡∏ß‡∏õ.‡∏û‡∏≠.</option>
                                <option value="director">‡∏ú‡∏≠.‡∏Å‡∏ß‡∏õ.‡∏û‡∏≠.</option>
                            </select>
                        </div>

                        <div class="grid grid-cols-2 gap-4 mb-4">
                            <div><label class="block text-gray-600 text-sm mb-1">‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</label><input type="date" id="startDate" class="w-full p-3 rounded-lg border" required></div>
                            <div><label class="block text-gray-600 text-sm mb-1">‡∏ñ‡∏∂‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</label><input type="date" id="endDate" class="w-full p-3 rounded-lg border" required></div>
                        </div>

                        <div class="mb-4">
                            <label class="block text-gray-700 font-bold mb-2">‡πÑ‡∏õ‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î / ‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠</label>
                            <input type="text" id="reason" class="w-full p-3 rounded-lg border" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏à.‡∏™‡∏∏‡∏û‡∏£‡∏£‡∏ì‡∏ö‡∏∏‡∏£‡∏µ" required>
                        </div>

                        <div class="mb-6">
                            <label class="block text-gray-700 font-bold mb-2">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ß‡∏±‡∏ô‡∏•‡∏≤</label>
                            <input type="number" id="totalDays" class="w-full p-3 rounded-lg border bg-yellow-50" placeholder="‡∏£‡∏∞‡∏ö‡∏ö‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÉ‡∏´‡πâ...">
                            <p class="text-xs text-gray-500 mt-1" id="day-hint">* ‡∏•‡∏≤‡∏û‡∏±‡∏Å‡∏ú‡πà‡∏≠‡∏ô‡∏ô‡∏±‡∏ö‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ß‡∏±‡∏ô‡∏ó‡∏≥‡∏Å‡∏≤‡∏£, ‡∏•‡∏≤‡∏õ‡πà‡∏ß‡∏¢‡∏ô‡∏±‡∏ö‡∏ó‡∏∏‡∏Å‡∏ß‡∏±‡∏ô</p>
                        </div>

                        <div class="flex items-center mb-4 space-x-4">
                            <div class="flex items-center">
                                <input id="debugCheck" type="checkbox" class="w-4 h-4 text-red-600 border-gray-300 rounded">
                                <label for="debugCheck" class="ml-2 text-sm text-gray-700">‡πÇ‡∏´‡∏°‡∏î‡∏ä‡πà‡∏ß‡∏¢‡πÄ‡∏•‡πá‡∏á (‡∏à‡∏∏‡∏î‡πÅ‡∏î‡∏áüî¥)</label>
                            </div>
                        </div>

                        <button type="submit" id="btn-submit" class="w-full bg-blue-600 text-white text-lg py-3 rounded-lg font-bold shadow hover:bg-blue-700">
                            üñ®Ô∏è ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡∏∞‡∏û‡∏¥‡∏°‡∏û‡πå (PDF)
                        </button>
                    </form>
                </div>

                <!-- HISTORY SECTION -->
                <div id="section-history" class="hidden-section">
                    <ul id="historyList" class="space-y-3 max-h-96 overflow-y-auto">
                        <li class="text-center text-gray-400 py-4">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</li>
                    </ul>
                </div>

            </div>
        </div>
    </div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyAxgj4sKMUdMQJWj2hU2rbcT4eZ926sskQ",
            authDomain: "leave-system-online.firebaseapp.com",
            projectId: "leave-system-online",
            storageBucket: "leave-system-online.firebasestorage.app",
            messagingSenderId: "801381918860",
            appId: "1:801381918860:web:035197d704d8e6712f73a9",
            measurementId: "G-D4P9EB6K7H"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        // USERS DATA (‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡πÉ‡∏´‡∏°‡πà)
        const initialUsers = [
            { id: "u001", rank: "‡∏ô.‡∏ó.‡∏´‡∏ç‡∏¥‡∏á", name: "‡∏û‡∏±‡∏ä‡∏£‡∏¥‡∏ô‡∏ó‡∏£‡πå ‡∏ß‡∏á‡∏©‡πå‡∏ß‡∏∏‡∏í‡∏¥‡∏®‡∏±‡∏Å‡∏î‡∏¥‡πå", gender: "female", position: "‡∏ô.‡∏™‡∏∏‡∏Ç‡∏≤‡∏†‡∏¥‡∏ö‡∏≤‡∏• ‡∏ú‡∏™‡∏†.‡∏Å‡∏ß‡∏õ.‡∏û‡∏≠.", quota: { sick: 60, personal: 45, vacation: 10 } },
            { id: "u002", rank: "‡∏ô.‡∏ó.‡∏´‡∏ç‡∏¥‡∏á", name: "‡∏Ç‡∏à‡∏£‡∏à‡∏¥‡∏ï‡∏ï‡πå ‡∏ä‡∏¥‡∏ì‡∏û‡∏á‡∏®‡πå", gender: "female", position: "‡∏õ‡∏£‡∏∞‡∏à‡∏≥ ‡∏û‡∏≠.", quota: { sick: 60, personal: 45, vacation: 10 } },
            { id: "u003", rank: "‡∏ô.‡∏ï.", name: "‡∏ò‡∏ì‡∏Å‡∏£ ‡∏û‡∏∂‡πà‡∏á‡∏û‡∏¥‡∏°‡∏≤‡∏¢", gender: "male", position: "‡∏ô.‡∏™‡∏∏‡∏Ç‡∏≤‡∏†‡∏¥‡∏ö‡∏≤‡∏• ‡∏ú‡∏™‡∏†.‡∏Å‡∏ß‡∏õ.‡∏û‡∏≠.", quota: { sick: 60, personal: 45, vacation: 10 } },
            { id: "u004", rank: "‡∏ô.‡∏ï.‡∏´‡∏ç‡∏¥‡∏á", name: "‡∏Å‡∏≤‡∏ô‡∏ï‡πå‡∏û‡∏¥‡∏ä‡∏ä‡∏≤ ‡πÄ‡∏ä‡∏≤‡∏ß‡∏•‡∏¥‡∏ï", gender: "female", position: "‡∏ô.‡∏™‡∏∏‡∏Ç‡∏≤‡∏†‡∏¥‡∏ö‡∏≤‡∏• ‡∏ú‡∏™‡∏†.‡∏Å‡∏ß‡∏õ.‡∏û‡∏≠.", quota: { sick: 60, personal: 45, vacation: 10 } },
            { id: "u005", rank: "‡∏£.‡∏≠.‡∏´‡∏ç‡∏¥‡∏á", name: "‡∏£‡∏∏‡πà‡∏á‡∏ó‡∏¥‡∏ß‡∏≤ ‡∏£‡∏±‡∏ï‡∏ô‡πå‡∏≠‡πà‡∏≠‡∏ô", gender: "female", position: "‡∏ô.‡∏™‡∏∏‡∏Ç‡∏≤‡∏†‡∏¥‡∏ö‡∏≤‡∏• ‡∏ú‡∏™‡∏†.‡∏Å‡∏ß‡∏õ.‡∏û‡∏≠.", quota: { sick: 60, personal: 45, vacation: 10 } },
            { id: "u006", rank: "‡∏£.‡∏≠.‡∏´‡∏ç‡∏¥‡∏á", name: "‡∏≠‡∏†‡∏¥‡∏£‡∏≤‡∏° ‡∏™‡∏ò‡∏ô‡∏Å‡∏∏‡∏•", gender: "female", position: "‡∏ô.‡∏™‡∏∏‡∏Ç‡∏≤‡∏†‡∏¥‡∏ö‡∏≤‡∏• ‡∏ú‡∏™‡∏†.‡∏Å‡∏ß‡∏õ.‡∏û‡∏≠.", quota: { sick: 60, personal: 45, vacation: 10 } },
            { id: "u007", rank: "‡∏£.‡∏≠.‡∏´‡∏ç‡∏¥‡∏á", name: "‡∏ï‡∏£‡∏µ‡∏ê‡∏¥‡∏ï‡∏≤ ‡∏≠‡∏¥‡∏ô‡∏ó‡∏∞‡∏ä‡∏±‡∏¢", gender: "female", position: "‡∏ô.‡∏™‡∏∏‡∏Ç‡∏≤‡∏†‡∏¥‡∏ö‡∏≤‡∏• ‡∏ú‡∏™‡∏†.‡∏Å‡∏ß‡∏õ.‡∏û‡∏≠.", quota: { sick: 60, personal: 45, vacation: 10 } },
            { id: "u008", rank: "‡∏û.‡∏≠.‡∏≠.", name: "‡∏ô‡∏û‡∏û‡∏£ ‡∏≠‡∏£‡∏∏‡∏ì‡∏â‡∏≤‡∏¢", gender: "male", position: "‡∏à‡∏ô‡∏ó.‡∏™‡∏∏‡∏Ç‡∏≤‡∏†‡∏¥‡∏ö‡∏≤‡∏• ‡∏ú‡∏™‡∏†.‡∏Å‡∏ß‡∏õ.‡∏û‡∏≠.", quota: { sick: 60, personal: 45, vacation: 10 } },
            { id: "u009", rank: "‡∏û.‡∏≠.‡∏≠.‡∏´‡∏ç‡∏¥‡∏á", name: "‡∏™‡∏∏‡∏ò‡∏¥‡∏°‡∏≤ ‡∏®‡∏¥‡∏£‡∏¥‡∏û‡∏¥‡∏û‡∏±‡∏í‡∏ô‡πå‡∏û‡∏á‡∏©‡πå", gender: "female", position: "‡∏à‡∏ô‡∏ó.‡∏™‡∏∏‡∏Ç‡∏≤‡∏†‡∏¥‡∏ö‡∏≤‡∏• ‡∏ú‡∏™‡∏†.‡∏Å‡∏ß‡∏õ.‡∏û‡∏≠.", quota: { sick: 60, personal: 45, vacation: 10 } },
            { id: "u010", rank: "‡∏û.‡∏≠.‡∏ï.", name: "‡∏†‡∏π‡∏£‡∏¥‡∏û‡∏á‡∏©‡πå ‡∏™‡∏•‡∏≤‡∏á‡∏™‡∏¥‡∏á‡∏´‡πå", gender: "male", position: "‡∏à‡∏ô‡∏ó.‡∏™‡∏∏‡∏Ç‡∏≤‡∏†‡∏¥‡∏ö‡∏≤‡∏• ‡∏ú‡∏™‡∏†.‡∏Å‡∏ß‡∏õ.‡∏û‡∏≠.", quota: { sick: 60, personal: 45, vacation: 10 } },
            { id: "u011", rank: "‡∏ô‡∏≤‡∏¢", name: "‡∏Å‡∏§‡∏©‡∏î‡∏≤ ‡∏Ñ‡∏á‡∏Å‡∏±‡∏•‡∏õ‡πå", gender: "male", position: "‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£‡∏™‡∏∏‡∏Ç‡∏≤‡∏†‡∏¥‡∏ö‡∏≤‡∏•", quota: { sick: 60, personal: 45, vacation: 10 } },
            { id: "u012", rank: "‡∏ô‡∏≤‡∏¢", name: "‡∏õ‡∏£‡∏∞‡πÄ‡∏™‡∏£‡∏¥‡∏ê ‡∏ó‡∏±‡∏ö‡πÅ‡∏ñ‡∏°", gender: "male", position: "‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£‡∏™‡∏∏‡∏Ç‡∏≤‡∏†‡∏¥‡∏ö‡∏≤‡∏•", quota: { sick: 60, personal: 45, vacation: 10 } },
            { id: "u013", rank: "‡∏ô.‡∏™.", name: "‡πÄ‡∏™‡∏≤‡∏ß‡∏ì‡∏µ‡∏¢‡πå ‡∏≠‡∏¥‡∏ô‡∏Å‡∏≤‡∏¢", gender: "female", position: "‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£‡∏™‡∏∏‡∏Ç‡∏≤‡∏†‡∏¥‡∏ö‡∏≤‡∏•", quota: { sick: 60, personal: 45, vacation: 10 } },
            { id: "u015", rank: "‡∏ô‡∏≤‡∏¢", name: "‡∏≠‡∏†‡∏¥‡∏£‡∏±‡∏Å‡∏©‡πå ‡∏ô‡∏¥‡∏•‡πÄ‡∏Å‡∏©‡∏°", gender: "male", position: "‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏ò‡∏∏‡∏£‡∏Å‡∏≤‡∏£", quota: { sick: 60, personal: 45, vacation: 10 } }
        ];

        let allUsers = [];
        let currentUser = null;
        let historyUnsubscribe = null;

        async function initSystem() {
            try {
                const snapshot = await db.collection("users").get();
                const batch = db.batch();
                let hasUpdates = false;

                if (!snapshot.empty) {
                    allUsers = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                }

                initialUsers.forEach(initUser => {
                    const exists = allUsers.find(u => u.id === initUser.id);
                    if (!exists) {
                        batch.set(db.collection("users").doc(initUser.id), initUser);
                        allUsers.push(initUser);
                        hasUpdates = true;
                    } else if (exists.position !== initUser.position) {
                        batch.update(db.collection("users").doc(initUser.id), { position: initUser.position });
                        exists.position = initUser.position;
                        hasUpdates = true;
                    }
                });

                if (hasUpdates) await batch.commit();
                allUsers.sort((a, b) => a.id.localeCompare(b.id));

                document.getElementById('loading-screen').style.display = 'none';
                document.getElementById('screen-home').style.display = 'flex';
                renderUserList(allUsers);

            } catch (error) { 
                allUsers = initialUsers;
                document.getElementById('loading-screen').style.display = 'none';
                document.getElementById('screen-home').style.display = 'flex';
                renderUserList(allUsers);
            }
        }

        function renderUserList(users) {
            const list = document.getElementById('userList');
            list.innerHTML = '';
            users.forEach(u => {
                const div = document.createElement('div');
                div.className = 'p-3 border-b cursor-pointer hover:bg-gray-100 flex justify-between items-center';
                div.innerHTML = `
                    <div class="flex items-center">
                        <div class="w-8 h-8 rounded-full bg-blue-100 flex items-center justify-center text-xs mr-3 text-blue-600 font-bold">${u.id.replace('u','')}</div>
                        <span>${u.rank} ${u.name}</span>
                    </div>
                    <span class="text-xs text-gray-400">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å ></span>`;
                div.onclick = () => selectUser(u);
                list.appendChild(div);
            });
        }

        function filterUsers() {
            const val = document.getElementById('searchInput').value;
            renderUserList(val ? allUsers.filter(u => u.name.includes(val) || u.rank.includes(val)) : allUsers);
        }

        function selectUser(u) {
            currentUser = u;
            document.getElementById('screen-home').style.display = 'none';
            document.getElementById('screen-dashboard').style.display = 'block';
            document.getElementById('user-fullname').innerText = `${u.rank} ${u.name}`;
            document.getElementById('userPosition').value = u.position || '';
            listenToHistory(u.id);
        }

        function listenToHistory(userId) {
            const list = document.getElementById('historyList');
            if (historyUnsubscribe) historyUnsubscribe();

            list.innerHTML = '<li class="text-center text-gray-400 py-4">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</li>';

            historyUnsubscribe = db.collection("leave_records")
                .where("userId", "==", userId)
                .orderBy("timestamp", "desc")
                .limit(10)
                .onSnapshot((snapshot) => {
                    if (snapshot.empty) {
                        list.innerHTML = '<li class="text-center text-gray-400 py-4">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏•‡∏≤</li>';
                        return;
                    }
                    list.innerHTML = '';
                    snapshot.forEach(doc => {
                        const d = doc.data();
                        const isCancel = d.leaveType === 'cancel';
                        const colorClass = isCancel ? "bg-red-50 border-red-200" : "bg-white border-gray-200";
                        const typeText = translateType(d.leaveType);
                        list.innerHTML += `
                            <li class="p-3 border rounded-lg shadow-sm ${colorClass} flex justify-between items-center">
                                <div>
                                    <div class="font-bold text-gray-700">${typeText} ${isCancel ? '(‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å)' : ''}</div>
                                    <div class="text-xs text-gray-500">${formatDateThai(d.startDate)} (${d.totalDays} ‡∏ß‡∏±‡∏ô)</div>
                                    <div class="text-xs text-gray-400 mt-1">${d.reason || '-'}</div>
                                </div>
                                <div class="text-xs bg-gray-100 px-2 py-1 rounded text-gray-500">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡πâ‡∏ß</div>
                            </li>`;
                    });
                }, (error) => {
                    console.error("History Error:", error);
                    list.innerHTML = '<li class="text-center text-red-400 py-4">‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à (‡∏Ñ‡∏•‡∏¥‡∏Å F12 ‡∏™‡∏£‡πâ‡∏≤‡∏á Index)</li>';
                });
        }

        function translateType(t) {
            const map = { 'vacation': '‡∏•‡∏≤‡∏û‡∏±‡∏Å‡∏ú‡πà‡∏≠‡∏ô', 'sick': '‡∏•‡∏≤‡∏õ‡πà‡∏ß‡∏¢', 'personal': '‡∏•‡∏≤‡∏Å‡∏¥‡∏à', 'overseas': '‡∏•‡∏≤‡∏û‡∏±‡∏Å‡∏ú‡πà‡∏≠‡∏ô‡∏ï‡πà‡∏≤‡∏á‡∏õ‡∏£‡∏∞‡πÄ‡∏ó‡∏®', 'cancel': '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏ß‡∏±‡∏ô‡∏•‡∏≤' };
            return map[t] || t;
        }

        function formatDateThai(dateStr) {
            const d = new Date(dateStr);
            const m = ['‡∏°.‡∏Ñ.','‡∏Å.‡∏û.','‡∏°‡∏µ.‡∏Ñ.','‡πÄ‡∏°.‡∏¢.','‡∏û.‡∏Ñ.','‡∏°‡∏¥.‡∏¢.','‡∏Å.‡∏Ñ.','‡∏™.‡∏Ñ.','‡∏Å.‡∏¢.','‡∏ï.‡∏Ñ.','‡∏û.‡∏¢.','‡∏ò.‡∏Ñ.'];
            return `${d.getDate()} ${m[d.getMonth()]} ${d.getFullYear()+543}`;
        }

        function switchTab(tab) {
            const reqSec = document.getElementById('section-request');
            const hisSec = document.getElementById('section-history');
            const btnReq = document.getElementById('tab-btn-request');
            const btnHis = document.getElementById('tab-btn-history');

            if (tab === 'request') {
                reqSec.style.display = 'block';
                hisSec.style.display = 'none';
                btnReq.className = "flex-1 py-2 font-bold text-blue-600 border-b-2 border-blue-600";
                btnHis.className = "flex-1 py-2 font-bold text-gray-400 hover:text-gray-600";
            } else {
                reqSec.style.display = 'none';
                hisSec.style.display = 'block';
                btnHis.className = "flex-1 py-2 font-bold text-blue-600 border-b-2 border-blue-600";
                btnReq.className = "flex-1 py-2 font-bold text-gray-400 hover:text-gray-600";
            }
        }

        // ============================================
        // üñ®Ô∏è PDF LOGIC (COORDINATES MATCHED TO IMAGE)
        // ============================================
        function toThaiNum(num) {
            if(num === null || num === undefined) return '';
            const thaiDigits = ['‡πê','‡πë','‡πí','‡πì','‡πî','‡πï','‡πñ','‡πó','‡πò','‡πô'];
            return num.toString().split('').map(char => thaiDigits[char] || char).join('');
        }

        function formatMonth(m) { 
            return ['‡∏°.‡∏Ñ.','‡∏Å.‡∏û.','‡∏°‡∏µ.‡∏Ñ.','‡πÄ‡∏°.‡∏¢.','‡∏û.‡∏Ñ.','‡∏°‡∏¥.‡∏¢.','‡∏Å.‡∏Ñ.','‡∏™.‡∏Ñ.','‡∏Å.‡∏¢.','‡∏ï.‡∏Ñ.','‡∏û.‡∏¢.','‡∏ò.‡∏Ñ.'][m]; 
        }

        async function generatePDF(user, type, start, end, reason, extra) {
            try {
                const fileMap = { 
                    'vacation': 'form_vacation.pdf', 'sick': 'form_sick.pdf', 'personal': 'form_personal.pdf',
                    'ordination': 'form_ordination.pdf', 'maternity': 'form_maternity.pdf', 'help_wife': 'form_help_wife.pdf',
                    'cancel': 'form_cancel.pdf'
                };
                
                const fontBytes = await fetch('./Sarabun.ttf').then(res => res.arrayBuffer());
                const pdfBytes = await fetch('./' + fileMap[type]).then(res => res.arrayBuffer());
                
                const pdfDoc = await PDFLib.PDFDocument.load(pdfBytes);
                pdfDoc.registerFontkit(fontkit);
                const thaiFont = await pdfDoc.embedFont(fontBytes);
                const page = pdfDoc.getPages()[0];
                const isDebug = document.getElementById('debugCheck').checked;
                
                const draw = (text, x, y, size=16) => {
                    page.drawText(toThaiNum(text) || '', { x, y, size, font: thaiFont, color: PDFLib.rgb(0,0,0) });
                    if(isDebug) {
                        page.drawCircle({ x, y, size: 2, color: PDFLib.rgb(1, 0, 0) });
                        page.drawText(`(${x},${y})`, { x: x+5, y: y+2, size: 8, font: thaiFont, color: PDFLib.rgb(1, 0, 0) });
                    }
                };

                const strike = (x, y, width=15) => { // ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏¢‡∏≤‡∏ß‡∏Ç‡∏µ‡∏î 15 ‡∏´‡∏ô‡πà‡∏ß‡∏¢
                    page.drawLine({ start: { x, y: y+5 }, end: { x: x+width, y: y+5 }, thickness: 1, color: PDFLib.rgb(0,0,0) });
                    if(isDebug) {
                        page.drawCircle({ x, y: y+5, size: 3, color: PDFLib.rgb(1, 0, 0) }); 
                    }
                };

                const dStart = new Date(start);
                const dEnd = new Date(end);
                const now = new Date();
                const totalDays = document.getElementById('totalDays').value || '0';
                const toWhom = document.getElementById('toWhom').value;
                const userPos = document.getElementById('userPosition').value;

                // --- 1. ‡∏™‡πà‡∏ß‡∏ô‡∏´‡∏±‡∏ß (Header) ---
                draw('‡∏ú‡∏™‡∏†.‡∏Å‡∏ß‡∏õ.‡∏û‡∏≠.', 430, 740); 
                draw(now.getDate(), 353, 720); 
                draw(formatMonth(now.getMonth()), 420, 720); 
                draw(now.getFullYear()+543, 493, 720); 

                const toText = toWhom === 'head' ? '‡∏´‡∏ô.‡∏ú‡∏™‡∏†.‡∏Å‡∏ß‡∏õ.‡∏û‡∏≠.' : '‡∏ú‡∏≠.‡∏Å‡∏ß‡∏õ.‡∏û‡∏≠.';
                draw(toText, 100, 675);

                // --- 2. ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡∏•‡∏≤ ---
                // ‡∏Ç‡∏µ‡∏î‡∏Ü‡πà‡∏≤‡∏Ñ‡∏≥‡∏ô‡∏≥‡∏´‡∏ô‡πâ‡∏≤ (‡πÉ‡∏ä‡πâ‡∏û‡∏¥‡∏Å‡∏±‡∏î‡∏°‡∏≤‡∏ï‡∏£‡∏ê‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏•‡πá‡∏á‡πÑ‡∏ß‡πâ)
                if (user.gender === 'male') {
                    strike(165, 655); // ‡∏Ç‡∏µ‡∏î "‡∏î‡∏¥‡∏â‡∏±‡∏ô"
                } else {
                    strike(125, 655); // ‡∏Ç‡∏µ‡∏î "‡∏Å‡∏£‡∏∞‡∏ú‡∏°"
                }

                draw(`${user.rank} ${user.name}`, 216, 625); // ‡∏ä‡∏∑‡πà‡∏≠
                draw(userPos || '-', 390, 625); // ‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á (‡πÑ‡∏°‡πà‡∏°‡∏µ ‡∏Å‡∏ß‡∏õ.‡∏û‡∏≠. ‡πÅ‡∏•‡πâ‡∏ß)

                // --- 3. ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÉ‡∏ö‡∏•‡∏≤‡∏û‡∏±‡∏Å‡∏ú‡πà‡∏≠‡∏ô (‡πÅ‡∏ö‡∏ö ‡πó) ---
                if (type === 'vacation') {
                    // ‡∏Å‡∏≥‡∏´‡∏ô‡∏î ... ‡∏ß‡∏±‡∏ô
                    draw(totalDays, 315, 600); 

                    // ‡∏ï‡∏±‡πâ‡∏á‡πÅ‡∏ï‡πà‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà
                    draw(dStart.getDate(), 445, 600);
                    draw(formatMonth(dStart.getMonth()), 110, 578);
                    draw((dStart.getFullYear()+543).toString().slice(-2), 225, 578);

                    // ‡∏ñ‡∏∂‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà
                    draw(dEnd.getDate(), 375, 578); 
                    draw(formatMonth(dEnd.getMonth()), 470, 578);
                    draw((dEnd.getFullYear()+543).toString().slice(-2), 96, 556);

                    // ‡∏Ç‡∏µ‡∏î‡∏Ü‡πà‡∏≤ "‡∏Å‡∏£‡∏∞‡∏ú‡∏°/‡∏î‡∏¥‡∏â‡∏±‡∏ô" (‡πÉ‡∏ô‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤)
                    if (user.gender === 'male') {
                        strike(170, 530); // ‡∏Ç‡∏µ‡∏î "‡∏î‡∏¥‡∏â‡∏±‡∏ô"
                    } else {
                        strike(135, 530); // ‡∏Ç‡∏µ‡∏î "‡∏Å‡∏£‡∏∞‡∏ú‡∏°"
                    }

                    // ‡πÑ‡∏õ‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î
                    draw(reason, 350, 556); 

                    // ‡∏™‡πà‡∏ß‡∏ô‡∏ó‡πâ‡∏≤‡∏¢: "‡πÉ‡∏ô‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà... ‡πÅ‡∏•‡∏∞‡∏Å‡∏•‡∏±‡∏ö‡πÉ‡∏ô‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà..."
                    // ‡∏ß‡∏±‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏•‡∏≤
                    draw(dStart.getDate(), 115, 535);
                    draw(formatMonth(dStart.getMonth()), 230, 535);
                    draw((dStart.getFullYear()+543).toString().slice(-2), 345, 535);

                    // ‡∏ß‡∏±‡∏ô‡∏Å‡∏•‡∏±‡∏ö
                    draw(dEnd.getDate(), 460, 535);
                    draw(formatMonth(dEnd.getMonth()), 125, 515);
                    draw((dEnd.getFullYear()+543).toString().slice(-2), 212, 515);
                }

                // Save
                const pdfBytesOut = await pdfDoc.save();
                const blob = new Blob([pdfBytesOut], { type: "application/pdf" });
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = `‡πÉ‡∏ö‡∏•‡∏≤_${user.name}.pdf`;
                link.click();

            } catch (err) {
                console.error(err);
                alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: " + err.message);
            }
        }

        async function handleSaveAndPrint(e) {
            e.preventDefault();
            const btn = document.getElementById('btn-submit');
            const originalText = btn.innerText;
            btn.innerText = "‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ó‡∏≥‡∏á‡∏≤‡∏ô...";
            btn.disabled = true;
            
            const type = document.getElementById('leaveType').value;
            const start = document.getElementById('startDate').value;
            const end = document.getElementById('endDate').value;
            const reason = document.getElementById('reason').value;
            const days = parseInt(document.getElementById('totalDays').value || '0');
            
            try {
                // 1. Generate PDF
                await generatePDF(currentUser, type, start, end, reason, {});
                
                // 2. Save Data
                await db.collection("leave_records").add({
                    userId: currentUser.id,
                    userName: currentUser.name,
                    leaveType: type,
                    startDate: start,
                    endDate: end,
                    totalDays: days,
                    reason: reason,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                });

                // 3. Update Quota
                const userRef = db.collection("users").doc(currentUser.id);
                const field = type === 'sick' ? 'quota.used_sick' : type === 'personal' ? 'quota.used_personal' : 'quota.used_vacation';
                await userRef.update({ [field]: firebase.firestore.FieldValue.increment(days) });

                alert("‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!");
                document.getElementById('leaveForm').reset();
                
            } catch (err) {
                alert("Error: " + err.message);
            } finally {
                btn.innerText = originalText;
                btn.disabled = false;
            }
        }

        document.getElementById('endDate').addEventListener('change', () => {
            const s = new Date(document.getElementById('startDate').value);
            const e = new Date(document.getElementById('endDate').value);
            const type = document.getElementById('leaveType').value;
            if(s && e) {
                let count = 0; let cur = new Date(s);
                while(cur <= e) {
                    const day = cur.getDay();
                    if(type === 'sick') count++; else if(day !== 0 && day !== 6) count++;
                    cur.setDate(cur.getDate() + 1);
                }
                document.getElementById('totalDays').value = count;
            }
        });

        initSystem();
    </script>
</body>
</html>
