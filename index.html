<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏£‡∏∞‡∏ö‡∏ö‡∏•‡∏≤‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå (Sanitation Cute ‚ú®)</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;600;800&display=swap" rel="stylesheet">
    
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
    
    <script src="https://unpkg.com/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>
    <script src="https://unpkg.com/@pdf-lib/fontkit@0.0.4/dist/fontkit.umd.min.js"></script>

    <style>
        body { 
            font-family: 'Sarabun', sans-serif; 
            background: linear-gradient(135deg, #fdfbf7 0%, #eef2f3 100%);
        }
        .pastel-card {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.05);
        }
        .btn-pastel {
            transition: all 0.3s ease;
        }
        .btn-pastel:active { transform: scale(0.95); }
        .hidden-section { display: none; }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
    </style>
</head>
<body class="text-gray-700">

    <div id="loading-screen" class="fixed inset-0 bg-pink-50 z-50 flex flex-col items-center justify-center">
        <div class="animate-bounce text-6xl mb-4">üê∞</div>
        <p class="text-pink-400 text-xl font-bold animate-pulse">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏∞‡∏à‡πä‡∏∞...</p>
    </div>

    <div id="screen-home" class="min-h-screen flex flex-col items-center justify-center px-4 py-10 hidden-section bg-gradient-to-b from-pink-50 to-blue-50">
        
        <div class="text-center mb-8">
            <div class="text-6xl mb-2">üè•‚ú®</div>
            <h1 class="text-3xl font-extrabold text-gray-700">‡∏£‡∏∞‡∏ö‡∏ö‡πÉ‡∏ö‡∏•‡∏≤‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå</h1>
            <p class="text-gray-500 mt-2">‡πÅ‡∏ú‡∏ô‡∏Å‡∏™‡∏∏‡∏Ç‡∏≤‡∏†‡∏¥‡∏ö‡∏≤‡∏• ‡∏Ñ‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡∏≤‡∏î‡∏µ üíñ</p>
        </div>

        <div class="w-full max-w-md pastel-card p-6 border border-white">
            <label class="block text-gray-600 font-bold mb-3 ml-1">üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ ‡∏´‡∏£‡∏∑‡∏≠ ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì</label>
            
            <div class="relative mb-4">
                <span class="absolute inset-y-0 left-0 flex items-center pl-3 text-gray-400">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
                </span>
                <input type="text" id="searchInput" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏•‡πà‡∏ô ‡∏´‡∏£‡∏∑‡∏≠ ‡∏ä‡∏∑‡πà‡∏≠‡∏à‡∏£‡∏¥‡∏á‡∏Å‡πá‡πÑ‡∏î‡πâ..." 
                       class="w-full pl-10 p-4 rounded-xl bg-gray-50 border-2 border-pink-100 focus:border-pink-300 focus:outline-none focus:ring-2 focus:ring-pink-200 transition-colors"
                       onkeyup="filterUsers()">
            </div>

            <div class="mb-2 text-xs text-gray-400 ml-1">üëá ‡∏´‡∏£‡∏∑‡∏≠‡∏à‡∏¥‡πâ‡∏°‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á</div>
            <div id="userList" class="h-64 overflow-y-auto space-y-2 pr-2">
                </div>
        </div>
        
        <p class="mt-8 text-xs text-gray-400">¬© 2025 Sanitation Dept. | Made with üíñ</p>
    </div>

    <div id="screen-dashboard" class="hidden-section min-h-screen bg-gray-50 pb-10">
        
        <div class="bg-white rounded-b-3xl shadow-sm p-6 mb-6 relative overflow-hidden">
            <div class="absolute top-0 right-0 -mt-4 -mr-4 w-24 h-24 bg-yellow-100 rounded-full opacity-50 blur-xl"></div>
            <div class="absolute top-0 left-0 -ml-4 -mt-4 w-20 h-20 bg-pink-100 rounded-full opacity-50 blur-xl"></div>
            
            <div class="flex justify-between items-start relative z-10">
                <div class="flex items-center">
                    <div class="h-14 w-14 bg-gradient-to-tr from-pink-300 to-purple-300 rounded-2xl flex items-center justify-center text-white text-2xl font-bold shadow-md mr-4 ring-4 ring-white">
                        <span id="user-initial">?</span>
                    </div>
                    <div>
                        <h2 id="user-fullname" class="text-xl font-bold text-gray-800">...</h2>
                        <span class="inline-block bg-blue-100 text-blue-600 text-xs px-2 py-1 rounded-full font-bold mt-1">‡πÅ‡∏ú‡∏ô‡∏Å‡∏™‡∏∏‡∏Ç‡∏≤‡∏†‡∏¥‡∏ö‡∏≤‡∏•</span>
                    </div>
                </div>
                <button onclick="goHome()" class="bg-gray-100 hover:bg-gray-200 text-gray-500 p-2 rounded-xl transition">
                    ‚ùå ‡∏≠‡∏≠‡∏Å
                </button>
            </div>
        </div>

        <div class="container mx-auto px-4 max-w-2xl">
            <div class="flex bg-white p-1 rounded-2xl shadow-sm mb-6 mx-4">
                <button onclick="switchTab('request')" id="btn-tab-request" class="flex-1 py-3 text-center rounded-xl font-bold text-sm transition-all shadow-sm bg-pink-400 text-white">
                    üìù ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡πÉ‡∏ö‡∏•‡∏≤
                </button>
                <button onclick="switchTab('history')" id="btn-tab-history" class="flex-1 py-3 text-center rounded-xl font-bold text-sm text-gray-500 hover:bg-gray-50 transition-all">
                    üìä ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡∏±‡∏ô‡∏•‡∏≤
                </button>
            </div>

            <div id="tab-request" class="mx-2">
                <div class="pastel-card p-6 bg-white">
                    <form id="leaveForm" onsubmit="handleSaveAndPrint(event)">
                        
                        <div class="mb-5">
                            <label class="block text-gray-700 font-bold mb-2">üìå ‡∏à‡∏∞‡∏•‡∏≤‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏≠‡∏∞‡πÑ‡∏£‡∏î‡∏µ‡∏Ñ‡∏∞?</label>
                            <div class="relative">
                                <select id="leaveType" class="w-full p-4 rounded-xl bg-blue-50 border-none focus:ring-2 focus:ring-blue-200 appearance-none font-medium text-blue-800" onchange="toggleFields()">
                                    <option value="sick">üò∑ ‡∏•‡∏≤‡∏õ‡πà‡∏ß‡∏¢ (‡πÅ‡∏ö‡∏ö ‡πì)</option>
                                    <option value="personal">üöó ‡∏•‡∏≤‡∏Å‡∏¥‡∏à (‡πÅ‡∏ö‡∏ö ‡πñ)</option>
                                    <option value="vacation">üèñÔ∏è ‡∏•‡∏≤‡∏û‡∏±‡∏Å‡∏ú‡πà‡∏≠‡∏ô (‡πÅ‡∏ö‡∏ö ‡πó)</option>
                                    <option value="ordination">üôè ‡∏•‡∏≤‡∏≠‡∏∏‡∏õ‡∏™‡∏°‡∏ö‡∏ó (‡πÅ‡∏ö‡∏ö ‡πò)</option>
                                    <option value="maternity">üë∂ ‡∏•‡∏≤‡∏Ñ‡∏•‡∏≠‡∏î‡∏ö‡∏∏‡∏ï‡∏£ (‡πÅ‡∏ö‡∏ö ‡πî)</option>
                                    <option value="help_wife">üë®‚Äçüçº ‡∏•‡∏≤‡∏ä‡πà‡∏ß‡∏¢‡∏†‡∏£‡∏¥‡∏¢‡∏≤‡∏Ñ‡∏•‡∏≠‡∏î (‡πÅ‡∏ö‡∏ö ‡πï)</option>
                                    <option value="cancel">‚ùå ‡∏Ç‡∏≠‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏ß‡∏±‡∏ô‡∏•‡∏≤ (‡πÅ‡∏ö‡∏ö ‡πë‡πñ)</option>
                                </select>
                                <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-4 text-blue-500">
                                    <svg class="fill-current h-4 w-4" viewBox="0 0 20 20"><path d="M9.293 12.95l.707.707L15.657 8l-1.414-1.414L10 10.828 5.757 6.586 4.343 8z"/></svg>
                                </div>
                            </div>
                        </div>

                        <div class="grid grid-cols-2 gap-4 mb-5">
                            <div>
                                <label class="block text-gray-600 text-sm mb-1 ml-1">‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</label>
                                <input type="date" id="startDate" class="w-full p-3 rounded-xl bg-gray-50 border border-gray-200" required>
                            </div>
                            <div>
                                <label class="block text-gray-600 text-sm mb-1 ml-1">‡∏ñ‡∏∂‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</label>
                                <input type="date" id="endDate" class="w-full p-3 rounded-xl bg-gray-50 border border-gray-200" required>
                            </div>
                        </div>

                        <div class="mb-6">
                            <label id="reasonLabel" class="block text-gray-700 font-bold mb-2">üìù ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°</label>
                            <textarea id="reason" rows="3" class="w-full p-4 rounded-xl bg-yellow-50 border-none focus:ring-2 focus:ring-yellow-200 text-gray-700 placeholder-gray-400" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏õ‡∏ß‡∏î‡∏ó‡πâ‡∏≠‡∏á, ‡πÑ‡∏õ‡∏ó‡∏≥‡∏ò‡∏∏‡∏£‡∏∞‡∏ó‡∏µ‡πà ‡∏Å‡∏ó‡∏°."></textarea>
                        </div>

                        <button type="submit" id="btn-submit" class="w-full bg-gradient-to-r from-pink-400 to-rose-400 text-white text-lg py-4 rounded-2xl font-bold shadow-lg shadow-pink-200 hover:shadow-xl hover:scale-[1.02] btn-pastel flex justify-center items-center gap-2">
                            <span>üñ®Ô∏è</span> ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡∏∞‡∏û‡∏¥‡∏°‡∏û‡πå‡πÉ‡∏ö‡∏•‡∏≤
                        </button>
                    </form>
                </div>
            </div>

            <div id="tab-history" class="hidden-section mx-2">
                <div class="grid grid-cols-3 gap-3 mb-6">
                    <div class="bg-red-50 p-4 rounded-2xl text-center border border-red-100 shadow-sm">
                        <div class="text-2xl mb-1">üò∑</div>
                        <p class="text-xs text-red-400 font-bold uppercase">‡∏•‡∏≤‡∏õ‡πà‡∏ß‡∏¢‡πÄ‡∏´‡∏•‡∏∑‡∏≠</p>
                        <p class="text-3xl font-extrabold text-red-500 mt-1" id="quota-sick">-</p>
                    </div>
                    <div class="bg-blue-50 p-4 rounded-2xl text-center border border-blue-100 shadow-sm">
                        <div class="text-2xl mb-1">üöó</div>
                        <p class="text-xs text-blue-400 font-bold uppercase">‡∏•‡∏≤‡∏Å‡∏¥‡∏à‡πÄ‡∏´‡∏•‡∏∑‡∏≠</p>
                        <p class="text-3xl font-extrabold text-blue-500 mt-1" id="quota-personal">-</p>
                    </div>
                    <div class="bg-green-50 p-4 rounded-2xl text-center border border-green-100 shadow-sm">
                        <div class="text-2xl mb-1">üèñÔ∏è</div>
                        <p class="text-xs text-green-400 font-bold uppercase">‡∏û‡∏±‡∏Å‡∏£‡πâ‡∏≠‡∏ô‡πÄ‡∏´‡∏•‡∏∑‡∏≠</p>
                        <p class="text-3xl font-extrabold text-green-500 mt-1" id="quota-vacation">-</p>
                    </div>
                </div>
                
                <div class="bg-white rounded-2xl shadow-sm p-5">
                    <h3 class="font-bold text-gray-700 mb-4 flex items-center">
                        <span class="bg-purple-100 text-purple-600 p-1.5 rounded-lg mr-2 text-sm">üïí</span> 
                        ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏•‡∏≤‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î
                    </h3>
                    <ul id="historyList" class="space-y-3">
                        <li class="text-center text-gray-400 py-4">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- 1. CONFIGURATION (Key ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì) ---
        const firebaseConfig = {
            apiKey: "AIzaSyAxgj4sKMUdMQJWj2hU2rbcT4eZ926sskQ",
            authDomain: "leave-system-online.firebaseapp.com",
            projectId: "leave-system-online",
            storageBucket: "leave-system-online.firebasestorage.app",
            messagingSenderId: "801381918860",
            appId: "1:801381918860:web:035197d704d8e6712f73a9",
            measurementId: "G-D4P9EB6K7H"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        // --- 2. DATA USERS ---
        const initialUsers = [
            { id: "u001", rank: "‡∏ô.‡∏ó.‡∏´‡∏ç‡∏¥‡∏á", name: "‡∏û‡∏±‡∏ä‡∏£‡∏¥‡∏ô‡∏ó‡∏£‡πå ‡∏ß‡∏á‡∏©‡πå‡∏ß‡∏∏‡∏í‡∏¥‡∏®‡∏±‡∏Å‡∏î‡∏¥‡πå", quota: { sick: 60, personal: 45, vacation: 10, used_sick: 0, used_personal: 0, used_vacation: 0 } },
            { id: "u002", rank: "‡∏ô.‡∏ó.‡∏´‡∏ç‡∏¥‡∏á", name: "‡∏Ç‡∏à‡∏£‡∏à‡∏¥‡∏ï‡∏ï‡πå ‡∏ä‡∏¥‡∏ì‡∏û‡∏á‡∏®‡πå", quota: { sick: 60, personal: 45, vacation: 10, used_sick: 0, used_personal: 0, used_vacation: 0 } },
            { id: "u003", rank: "‡∏ô.‡∏ï.", name: "‡∏ò‡∏ì‡∏Å‡∏£ ‡∏û‡∏∂‡πà‡∏á‡∏û‡∏¥‡∏°‡∏≤‡∏¢", quota: { sick: 60, personal: 45, vacation: 10, used_sick: 0, used_personal: 0, used_vacation: 0 } },
            { id: "u004", rank: "‡∏ô.‡∏ï.‡∏´‡∏ç‡∏¥‡∏á", name: "‡∏Å‡∏≤‡∏ô‡∏ï‡πå‡∏û‡∏¥‡∏ä‡∏ä‡∏≤ ‡πÄ‡∏ä‡∏≤‡∏ß‡∏•‡∏¥‡∏ï", quota: { sick: 60, personal: 45, vacation: 10, used_sick: 0, used_personal: 0, used_vacation: 0 } },
            { id: "u005", rank: "‡∏£.‡∏≠.‡∏´‡∏ç‡∏¥‡∏á", name: "‡∏£‡∏∏‡πà‡∏á‡∏ó‡∏¥‡∏ß‡∏≤ ‡∏£‡∏±‡∏ï‡∏ô‡πå‡∏≠‡πà‡∏≠‡∏ô", quota: { sick: 60, personal: 45, vacation: 10, used_sick: 0, used_personal: 0, used_vacation: 0 } },
            { id: "u006", rank: "‡∏£.‡∏≠.‡∏´‡∏ç‡∏¥‡∏á", name: "‡∏≠‡∏†‡∏¥‡∏£‡∏≤‡∏° ‡∏™‡∏ò‡∏ô‡∏Å‡∏∏‡∏•", quota: { sick: 60, personal: 45, vacation: 10, used_sick: 0, used_personal: 0, used_vacation: 0 } },
            { id: "u007", rank: "‡∏£.‡∏≠.‡∏´‡∏ç‡∏¥‡∏á", name: "‡∏ï‡∏£‡∏µ‡∏ê‡∏¥‡∏ï‡∏≤ ‡∏≠‡∏¥‡∏ô‡∏ó‡∏∞‡∏ä‡∏±‡∏¢", quota: { sick: 60, personal: 45, vacation: 10, used_sick: 0, used_personal: 0, used_vacation: 0 } },
            { id: "u008", rank: "‡∏û.‡∏≠.‡∏≠.", name: "‡∏ô‡∏û‡∏û‡∏£ ‡∏≠‡∏£‡∏∏‡∏ì‡∏â‡∏≤‡∏¢", quota: { sick: 60, personal: 45, vacation: 10, used_sick: 0, used_personal: 0, used_vacation: 0 } },
            { id: "u009", rank: "‡∏û.‡∏≠.‡∏≠.‡∏´‡∏ç‡∏¥‡∏á", name: "‡∏™‡∏∏‡∏ò‡∏¥‡∏°‡∏≤ ‡∏®‡∏¥‡∏£‡∏¥‡∏û‡∏¥‡∏û‡∏±‡∏í‡∏ô‡πå‡∏û‡∏á‡∏©‡πå", quota: { sick: 60, personal: 45, vacation: 10, used_sick: 0, used_personal: 0, used_vacation: 0 } },
            { id: "u010", rank: "‡∏û.‡∏≠.‡∏ï.", name: "‡∏†‡∏π‡∏£‡∏¥‡∏û‡∏á‡∏©‡πå ‡∏™‡∏•‡∏≤‡∏á‡∏™‡∏¥‡∏á‡∏´‡πå", quota: { sick: 60, personal: 45, vacation: 10, used_sick: 0, used_personal: 0, used_vacation: 0 } },
            { id: "u011", rank: "‡∏ô‡∏≤‡∏¢", name: "‡∏Å‡∏§‡∏©‡∏î‡∏≤ ‡∏Ñ‡∏á‡∏Å‡∏±‡∏•‡∏õ‡πå", quota: { sick: 60, personal: 45, vacation: 10, used_sick: 0, used_personal: 0, used_vacation: 0 } },
            { id: "u012", rank: "‡∏ô‡∏≤‡∏¢", name: "‡∏õ‡∏£‡∏∞‡πÄ‡∏™‡∏£‡∏¥‡∏ê ‡∏ó‡∏±‡∏ö‡πÅ‡∏ñ‡∏°", quota: { sick: 60, personal: 45, vacation: 10, used_sick: 0, used_personal: 0, used_vacation: 0 } },
            { id: "u013", rank: "‡∏ô.‡∏™.", name: "‡πÄ‡∏™‡∏≤‡∏ß‡∏ì‡∏µ‡∏¢‡πå ‡∏≠‡∏¥‡∏ô‡∏Å‡∏≤‡∏¢", quota: { sick: 60, personal: 45, vacation: 10, used_sick: 0, used_personal: 0, used_vacation: 0 } }
        ];

        let allUsers = [];
        let currentUser = null;

        // --- 3. LOGIC ---
        async function initSystem() {
            try {
                // Check local data first for speed (optional) or fetch directly
                const snapshot = await db.collection("users").get();
                if (snapshot.empty) {
                    console.log("First time setup...");
                    const batch = db.batch();
                    initialUsers.forEach((user) => {
                        const docRef = db.collection("users").doc(user.id);
                        batch.set(docRef, user);
                    });
                    await batch.commit();
                    allUsers = initialUsers;
                } else {
                    allUsers = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                }
                
                document.getElementById('loading-screen').style.display = 'none';
                document.getElementById('screen-home').style.display = 'flex'; // Changed to flex for centering
                renderUserList(allUsers);

            } catch (error) {
                alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠: " + error.message);
            }
        }

        function renderUserList(users) {
            const list = document.getElementById('userList');
            list.innerHTML = '';
            
            if(users.length === 0) {
                 list.innerHTML = '<div class="text-center text-gray-400 py-4">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ä‡∏∑‡πà‡∏≠‡∏ô‡∏µ‡πâ‡∏à‡πâ‡∏≤ üòÖ</div>';
                 return;
            }

            users.forEach(u => {
                const div = document.createElement('div');
                div.className = 'flex items-center p-3 rounded-xl cursor-pointer hover:bg-pink-50 transition border border-transparent hover:border-pink-200 group';
                div.onclick = () => selectUser(u);
                
                // Avatar ‡∏™‡∏∏‡πà‡∏°‡∏™‡∏µ
                const colors = ['bg-pink-200', 'bg-blue-200', 'bg-green-200', 'bg-yellow-200', 'bg-purple-200'];
                const randomColor = colors[Math.floor(Math.random() * colors.length)];
                
                div.innerHTML = `
                    <div class="h-10 w-10 ${randomColor} rounded-full flex items-center justify-center text-gray-600 font-bold mr-3 group-hover:scale-110 transition">
                        ${u.name.charAt(0)}
                    </div>
                    <div>
                        <div class="font-bold text-gray-700 group-hover:text-pink-500">${u.name}</div>
                        <div class="text-xs text-gray-400">${u.rank}</div>
                    </div>
                    <div class="ml-auto opacity-0 group-hover:opacity-100 text-pink-400">
                        ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å üëâ
                    </div>
                `;
                list.appendChild(div);
            });
        }

        function filterUsers() {
            const input = document.getElementById('searchInput').value;
            if(!input) { renderUserList(allUsers); return; }
            const filtered = allUsers.filter(u => u.name.includes(input) || u.rank.includes(input));
            renderUserList(filtered);
        }

        async function selectUser(user) {
            currentUser = user;
            document.getElementById('loading-screen').style.display = 'flex';
            
            // Fetch fresh data
            const doc = await db.collection("users").doc(user.id).get();
            currentUser = { id: doc.id, ...doc.data() };

            // UI Updates
            document.getElementById('user-fullname').innerText = `${currentUser.rank} ${currentUser.name}`;
            document.getElementById('user-initial').innerText = currentUser.name.charAt(0);
            
            updateQuotaUI();
            
            document.getElementById('loading-screen').style.display = 'none';
            document.getElementById('screen-home').style.display = 'none';
            document.getElementById('screen-dashboard').style.display = 'block';
            
            loadHistory(user.id);
        }

        function updateQuotaUI() {
            const q = currentUser.quota;
            document.getElementById('quota-sick').innerText = q.sick - q.used_sick;
            document.getElementById('quota-personal').innerText = q.personal - q.used_personal;
            document.getElementById('quota-vacation').innerText = q.vacation - q.used_vacation;
        }

        async function loadHistory(userId) {
            const list = document.getElementById('historyList');
            
            const snapshot = await db.collection("leave_records")
                                     .where("userId", "==", userId)
                                     .orderBy("timestamp", "desc")
                                     .limit(5)
                                     .get();
            
            list.innerHTML = '';
            if (snapshot.empty) {
                list.innerHTML = '<li class="text-center text-gray-400 py-4 text-sm bg-gray-50 rounded-xl">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏Ñ‡∏¢‡∏•‡∏≤‡πÄ‡∏•‡∏¢ ‡∏™‡∏∏‡∏î‡∏¢‡∏≠‡∏î! üëç</li>';
                return;
            }

            snapshot.forEach(doc => {
                const data = doc.data();
                const li = document.createElement('li');
                li.className = "flex justify-between items-center p-3 bg-white border border-gray-100 rounded-xl shadow-sm";
                li.innerHTML = `
                    <div class="flex items-center gap-3">
                        <div class="h-8 w-8 bg-gray-100 rounded-full flex items-center justify-center text-sm">üìÖ</div>
                        <div>
                            <p class="font-bold text-gray-700 text-sm">${translateType(data.leaveType)}</p>
                            <p class="text-xs text-gray-400">${formatDate(data.startDate)} (${data.totalDays} ‡∏ß‡∏±‡∏ô)</p>
                        </div>
                    </div>
                    <span class="text-xs bg-green-100 text-green-700 px-2 py-1 rounded-lg font-bold">‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à</span>
                `;
                list.appendChild(li);
            });
        }

        async function handleSaveAndPrint(e) {
            e.preventDefault();
            if(!confirm("‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏ô‡∏∞‡∏à‡πä‡∏∞?")) return;

            const btn = document.getElementById('btn-submit');
            const originalText = btn.innerHTML;
            btn.innerHTML = "‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏à‡πâ‡∏≤...";
            btn.disabled = true;

            const leaveType = document.getElementById('leaveType').value;
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;
            const reason = document.getElementById('reason').value;

            // Simple Day Calculation
            const start = new Date(startDate);
            const end = new Date(endDate);
            const diffTime = Math.abs(end - start);
            const totalDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)) + 1; 

            try {
                // 1. Save History
                await db.collection("leave_records").add({
                    userId: currentUser.id,
                    userName: currentUser.name,
                    leaveType: leaveType,
                    startDate: startDate,
                    endDate: endDate,
                    totalDays: totalDays,
                    reason: reason,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                });

                // 2. Cut Quota
                const userRef = db.collection("users").doc(currentUser.id);
                const updateField = {};
                if(leaveType === 'sick') updateField['quota.used_sick'] = firebase.firestore.FieldValue.increment(totalDays);
                if(leaveType === 'personal') updateField['quota.used_personal'] = firebase.firestore.FieldValue.increment(totalDays);
                if(leaveType === 'vacation') updateField['quota.used_vacation'] = firebase.firestore.FieldValue.increment(totalDays);
                
                if(Object.keys(updateField).length > 0) {
                    await userRef.update(updateField);
                }

                alert("‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢! ‡πÄ‡∏î‡∏µ‡πã‡∏¢‡∏ß‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏™‡∏£‡πâ‡∏≤‡∏á PDF ‡πÉ‡∏´‡πâ‡∏ô‡∏∞");
                location.reload();

            } catch (error) {
                console.error(error);
                alert("‡∏≠‡∏∏‡πä‡∏¢! ‡∏°‡∏µ‡∏õ‡∏±‡∏ç‡∏´‡∏≤: " + error.message);
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        }

        // --- Helpers ---
        function translateType(type) {
            const dict = { sick: "‡∏•‡∏≤‡∏õ‡πà‡∏ß‡∏¢", personal: "‡∏•‡∏≤‡∏Å‡∏¥‡∏à", vacation: "‡∏•‡∏≤‡∏û‡∏±‡∏Å‡∏£‡πâ‡∏≠‡∏ô", ordination: "‡∏•‡∏≤‡∏ö‡∏ß‡∏ä", maternity: "‡∏•‡∏≤‡∏Ñ‡∏•‡∏≠‡∏î", help_wife: "‡∏ä‡πà‡∏ß‡∏¢‡∏†‡∏£‡∏¥‡∏¢‡∏≤‡∏Ñ‡∏•‡∏≠‡∏î", cancel: "‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏ß‡∏±‡∏ô‡∏•‡∏≤" };
            return dict[type] || type;
        }

        function formatDate(dateStr) {
            // Convert 2025-11-28 to 28 ‡∏û.‡∏¢. 68 (Simple version)
            const d = new Date(dateStr);
            return `${d.getDate()}/${d.getMonth()+1}/${d.getFullYear()+543}`; 
        }

        function toggleFields() {
            const type = document.getElementById('leaveType').value;
            const label = document.getElementById('reasonLabel');
            const ph = document.getElementById('reason');
            
            if(type === 'sick') { label.innerText = "üè• ‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡∏õ‡πà‡∏ß‡∏¢ / ‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡∏Ç‡∏ì‡∏∞‡∏•‡∏≤"; ph.placeholder = "‡∏õ‡πà‡∏ß‡∏¢‡πÄ‡∏õ‡πá‡∏ô‡πÑ‡∏Ç‡πâ‡∏´‡∏ß‡∏±‡∏î ‡∏û‡∏±‡∏Å‡∏ó‡∏µ‡πà..."; }
            else if(type === 'personal') { label.innerText = "üöó ‡∏Å‡∏¥‡∏à‡∏ò‡∏∏‡∏£‡∏∞ / ‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î‡∏ó‡∏µ‡πà‡∏à‡∏∞‡πÑ‡∏õ"; ph.placeholder = "‡∏ó‡∏≥‡∏ò‡∏∏‡∏£‡∏∞‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß ‡πÑ‡∏õ‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î..."; }
            else { label.innerText = "üìù ‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏• / ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏"; ph.placeholder = "‡∏£‡∏∞‡∏ö‡∏∏‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î..."; }
        }

        function goHome() { location.reload(); }
        
        function switchTab(tab) {
            document.getElementById('tab-request').style.display = tab === 'request' ? 'block' : 'none';
            document.getElementById('tab-history').style.display = tab === 'history' ? 'block' : 'none';
            
            const btnReq = document.getElementById('btn-tab-request');
            const btnHis = document.getElementById('btn-tab-history');

            if(tab === 'request') {
                btnReq.className = "flex-1 py-3 text-center rounded-xl font-bold text-sm transition-all shadow-md bg-pink-400 text-white transform scale-105";
                btnHis.className = "flex-1 py-3 text-center rounded-xl font-bold text-sm text-gray-500 hover:bg-gray-50 transition-all";
            } else {
                btnHis.className = "flex-1 py-3 text-center rounded-xl font-bold text-sm transition-all shadow-md bg-blue-400 text-white transform scale-105";
                btnReq.className = "flex-1 py-3 text-center rounded-xl font-bold text-sm text-gray-500 hover:bg-gray-50 transition-all";
            }
        }

        initSystem();
    </script>
</body>
</html>
